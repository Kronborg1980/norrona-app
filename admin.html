<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Norröna CMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body{font-family:'Outfit',sans-serif;background-color:#0f172a; color:#e2e8f0;}
        .input-field {
            width:100%; padding:.75rem; background:#1e293b; border:1px solid #334155; color:white; border-radius:.5rem;
            transition:border-color .2s,box-shadow .2s;
        }
        .input-field:focus { outline:none; border-color:#06b6d4; box-shadow:0 0 0 2px rgba(6,182,212,.2); }
        .label { display:block; font-weight:600; color:#94a3b8; margin-bottom:.5rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .card { background:#1e293b; border:1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
        .btn-primary { background: linear-gradient(to right, #0891b2, #2563eb); color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: 0.2s; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-danger { color: #ef4444; transition: 0.2s; }
        .btn-danger:hover { color: #f87171; }
        .hidden{display:none}
        #notification{transition:opacity .5s,transform .5s}
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body>
    <div id="notification" class="hidden fixed top-5 right-5 bg-green-600 text-white py-3 px-5 rounded-lg shadow-lg z-[3000]"><p id="notification-message"></p></div>
    
    <div id="pat-screen" class="min-h-screen flex items-center justify-center bg-slate-900 relative overflow-hidden">
        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')] bg-cover opacity-10"></div>
        <div class="card w-full max-w-md relative z-10 shadow-2xl border-cyan-500/20 border">
            <h2 class="text-3xl font-bold text-center text-white mb-2">Admin Access</h2>
            <p class="text-center text-slate-400 mb-6 text-sm">Enter your GitHub Repository details to manage the app content.</p>
            <div class="space-y-4">
                <div><label class="label">GitHub Repo (user/repo)</label><input type="text" id="repo-name" class="input-field" value="Kronborg1980/norrona-app"></div>
                <div><label class="label">Personal Access Token</label><input type="password" id="pat-input" class="input-field" placeholder="ghp_..."></div>
                <button id="connect-btn" class="btn-primary w-full flex items-center justify-center gap-2 shadow-lg shadow-cyan-500/20"><span class="material-icons">rocket_launch</span> Connect</button>
                <p id="connect-error" class="text-red-400 text-xs text-center pt-2"></p>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <header class="bg-slate-900/90 backdrop-blur border-b border-slate-800 sticky top-0 z-50">
            <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold text-white flex items-center gap-2"><span class="material-icons text-cyan-400">admin_panel_settings</span> Norröna Manager</h1>
                <div class="text-xs text-slate-500" id="repo-display"></div>
            </div>
        </header>
        
        <main id="app" class="max-w-5xl mx-auto px-4 py-8 space-y-10 pb-32">
            <section>
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2"><span class="material-icons text-slate-600">settings</span> App Settings</h2>
                <div class="card">
                    <label class="label">Header Logo</label>
                    <div class="flex items-center gap-4">
                        <div class="bg-slate-800 p-2 rounded border border-slate-700"><img id="logo-preview" class="h-8"></div>
                        <input type="file" class="input-field text-sm" data-key="logoUrl" accept="image/*">
                    </div>
                </div>
            </section>

            <section>
                <div class="flex justify-between items-end mb-4 border-b border-slate-800 pb-4">
                    <h2 class="text-2xl font-bold text-white flex items-center gap-2"><span class="material-icons text-slate-600">layers</span> Navigation & Content</h2>
                </div>
                
                <div id="categories-container" class="space-y-8"></div>
                
                <button id="add-category" class="mt-8 w-full py-4 border-2 border-dashed border-slate-700 text-slate-500 hover:border-cyan-500 hover:text-cyan-400 rounded-xl transition flex items-center justify-center gap-2 font-bold">
                    <span class="material-icons">add_circle_outline</span> Add New Category Tab
                </button>
            </section>
        </main>

        <div class="fixed bottom-0 left-0 right-0 bg-slate-900/90 backdrop-blur border-t border-slate-800 p-4 z-50">
            <div class="max-w-5xl mx-auto flex justify-between items-center">
                <span class="text-xs text-slate-500">Changes are local until saved.</span>
                <button id="save-button" class="btn-primary px-8 py-3 text-lg shadow-lg shadow-blue-500/20 flex items-center gap-2">
                    <span class="material-icons">cloud_upload</span> Push to Live App
                </button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        let GITHUB_USERNAME, GITHUB_REPO, GITHUB_PAT;
        let appData = {};
        
        const connectBtn = document.getElementById("connect-btn");
        connectBtn.addEventListener('click', async () => {
            const repoFullName = document.getElementById('repo-name').value.trim();
            const pat = document.getElementById('pat-input').value.trim();
            const err = document.getElementById("connect-error");
            err.textContent = ''; connectBtn.disabled = true; connectBtn.innerHTML = 'Authenticating...';
            
            if (!repoFullName.includes('/') || !pat) {
                err.textContent = 'Invalid format. Use username/repo.'; connectBtn.disabled = false; return;
            }
            [GITHUB_USERNAME, GITHUB_REPO] = repoFullName.split('/'); GITHUB_PAT = pat;
            
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/data.json`, { headers: { 'Authorization': `token ${GITHUB_PAT}` }, cache: 'no-cache' });
                if (!response.ok) throw new Error('Connection failed. Check credentials.');
                const json = await response.json();
                appData = JSON.parse(decodeURIComponent(escape(atob(json.content))));
                
                document.getElementById("pat-screen").classList.add('hidden');
                document.getElementById("admin-panel").classList.remove('hidden');
                document.getElementById("repo-display").textContent = repoFullName;
                render();
            } catch (error) {
                err.textContent = error.message;
            } finally {
                connectBtn.disabled = false; connectBtn.innerHTML = '<span class="material-icons">rocket_launch</span> Connect';
            }
        });

        function render() {
            document.getElementById("logo-preview").src = appData.settings.logoUrl;
            const container = document.getElementById("categories-container");
            container.innerHTML = appData.categories.map((cat, cIdx) => `
                <div class="card relative group border-l-4 ${cat.type === 'home' ? 'border-l-purple-500' : 'border-l-cyan-500'}">
                    <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition">
                         <button class="remove-category btn-danger" data-c="${cIdx}" title="Delete Category"><span class="material-icons">delete</span></button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6 bg-slate-800/50 p-4 rounded-lg">
                        <div class="md:col-span-5">
                            <label class="label">Tab Title</label>
                            <input type="text" class="input-field text-lg font-bold" value="${cat.title}" data-c="${cIdx}" data-key="title">
                        </div>
                        <div class="md:col-span-2">
                             <label class="label">Icon</label>
                             <input type="text" class="input-field font-mono text-sm" value="${cat.icon}" data-c="${cIdx}" data-key="icon">
                        </div>
                        <div class="md:col-span-3">
                            <label class="label">Layout</label>
                            <select class="input-field" data-c="${cIdx}" data-key="type">
                                <option value="grid" ${cat.type==='grid'?'selected':''}>Standard Grid</option>
                                <option value="home" ${cat.type==='home'?'selected':''}>Home</option>
                                <option value="voyage" ${cat.type==='voyage'?'selected':''}>Voyage Map</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="label">ID</label>
                            <input type="text" class="input-field text-xs text-slate-500" value="${cat.id}" readonly>
                        </div>
                    </div>
                    <div class="space-y-4">
                        ${cat.items.map((item, iIdx) => `
                            <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="w-full mr-4">
                                        <label class="label">Item Name</label>
                                        <input type="text" class="input-field font-semibold" value="${item.name}" placeholder="Item Name" data-c="${cIdx}" data-i="${iIdx}" data-key="name">
                                    </div>
                                    <button class="remove-item btn-danger p-2" data-c="${cIdx}" data-i="${iIdx}"><span class="material-icons">close</span></button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="label">Description</label>
                                            <textarea class="input-field text-sm h-24" data-c="${cIdx}" data-i="${iIdx}" data-key="description">${item.description}</textarea>
                                        </div>
                                        <div>
                                            <label class="label">Images</label>
                                            <input type="file" class="input-field text-xs mb-2" data-c="${cIdx}" data-i="${iIdx}" accept="image/*" multiple>
                                            <div class="flex gap-2 overflow-x-auto pb-2">
                                                ${(item.images||[]).map((img, imgIdx) => `
                                                    <div class="relative flex-shrink-0">
                                                        <img src="${img}" class="h-16 w-16 object-cover rounded border border-slate-600">
                                                        <button class="remove-image absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center shadow-md" data-c="${cIdx}" data-i="${iIdx}" data-img="${imgIdx}">×</button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <div class="bg-slate-900/50 p-3 rounded border border-slate-700">
                                            <label class="label">Buttons</label>
                                            <div class="mb-2">
                                                <span class="text-xs text-cyan-400 uppercase mb-1 block">Primary (e.g. Book Table)</span>
                                                <div class="grid grid-cols-2 gap-2">
                                                    <input type="text" class="input-field text-sm" placeholder="Text" value="${item.link?.text||''}" data-c="${cIdx}" data-i="${iIdx}" data-key="linkText">
                                                    <input type="text" class="input-field text-sm" placeholder="URL" value="${item.link?.url||''}" data-c="${cIdx}" data-i="${iIdx}" data-key="linkUrl">
                                                </div>
                                            </div>
                                            <div>
                                                <span class="text-xs text-purple-400 uppercase mb-1 block">Secondary (e.g. Catalog/PDF)</span>
                                                <div class="grid grid-cols-2 gap-2">
                                                    <input type="text" class="input-field text-sm" placeholder="Text" value="${item.secondaryLink?.text||''}" data-c="${cIdx}" data-i="${iIdx}" data-key="secLinkText">
                                                    <input type="text" class="input-field text-sm" placeholder="URL" value="${item.secondaryLink?.url||''}" data-c="${cIdx}" data-i="${iIdx}" data-key="secLinkUrl">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-4">
                                        <div class="bg-slate-900/50 p-3 rounded border border-slate-700">
                                            <h4 class="label flex justify-between">Info / Hours <button class="add-field text-cyan-400 text-xs" data-c="${cIdx}" data-i="${iIdx}">+ ADD</button></h4>
                                            <div class="space-y-2">
                                                ${(item.fields||[]).map((f, fIdx) => `
                                                    <div class="flex gap-2">
                                                        <input type="text" class="input-field py-1 text-xs w-1/3" placeholder="Label (e.g. Lunch)" value="${f.label}" data-c="${cIdx}" data-i="${iIdx}" data-f="${fIdx}" data-key="label">
                                                        <input type="text" class="input-field py-1 text-xs w-2/3" placeholder="Value (e.g. 12-14)" value="${f.value}" data-c="${cIdx}" data-i="${iIdx}" data-f="${fIdx}" data-key="value">
                                                        <button class="remove-field text-red-500" data-c="${cIdx}" data-i="${iIdx}" data-f="${fIdx}">×</button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <div class="bg-slate-900/50 p-3 rounded border border-slate-700 border-l-4 border-l-yellow-500">
                                            <h4 class="label flex justify-between text-yellow-500">Special Offers <button class="add-offer text-yellow-500 text-xs" data-c="${cIdx}" data-i="${iIdx}">+ ADD</button></h4>
                                            <div class="space-y-2">
                                                ${(item.offers||[]).map((o, oIdx) => `
                                                    <div class="border-b border-slate-700 pb-2">
                                                        <div class="flex gap-2">
                                                            <input type="text" class="input-field py-1 text-xs w-full" placeholder="Offer Title" value="${o.title}" data-c="${cIdx}" data-i="${iIdx}" data-o="${oIdx}" data-key="title">
                                                            <button class="remove-offer text-red-500" data-c="${cIdx}" data-i="${iIdx}" data-o="${oIdx}">×</button>
                                                        </div>
                                                        <input type="text" class="input-field py-1 text-[10px] bg-transparent border-0 text-slate-400" placeholder="Offer Details..." value="${o.description}" data-c="${cIdx}" data-i="${iIdx}" data-o="${oIdx}" data-key="description">
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>

                                        <div class="bg-slate-900/50 p-3 rounded border border-slate-700">
                                            <h4 class="label flex justify-between">Menu Items <button class="add-menu text-cyan-400 text-xs" data-c="${cIdx}" data-i="${iIdx}">+ ADD</button></h4>
                                            <div class="space-y-3 max-h-48 overflow-y-auto">
                                                ${(item.menu||[]).map((m, mIdx) => `
                                                    <div class="border-b border-slate-700 pb-2">
                                                        <div class="flex gap-2 mb-1">
                                                            <input type="text" class="input-field py-1 text-xs w-2/3" placeholder="Item" value="${m.name}" data-c="${cIdx}" data-i="${iIdx}" data-m="${mIdx}" data-key="name">
                                                            <input type="text" class="input-field py-1 text-xs w-1/3 text-right" placeholder="Price" value="${m.price}" data-c="${cIdx}" data-i="${iIdx}" data-m="${mIdx}" data-key="price">
                                                            <button class="remove-menu text-red-500" data-c="${cIdx}" data-i="${iIdx}" data-m="${mIdx}">×</button>
                                                        </div>
                                                        <input type="text" class="input-field py-1 text-[10px] bg-transparent border-0 text-slate-400" placeholder="Description..." value="${m.description}" data-c="${cIdx}" data-i="${iIdx}" data-m="${mIdx}" data-key="description">
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        <button class="add-item w-full py-2 bg-slate-800 hover:bg-slate-700 text-cyan-400 text-sm font-semibold rounded border border-slate-700 transition" data-c="${cIdx}">+ Add New Card to ${cat.title}</button>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('app').addEventListener('input', e => {
            const t = e.target; const ds = t.dataset; if (!ds.c) return;
            if (ds.i === undefined) { appData.categories[ds.c][ds.key] = t.value; return; }
            const item = appData.categories[ds.c].items[ds.i];
            
            if (ds.key === 'linkText' || ds.key === 'linkUrl') { 
                if(!item.link) item.link = {}; item.link[ds.key === 'linkText' ? 'text' : 'url'] = t.value; 
            }
            else if (ds.key === 'secLinkText' || ds.key === 'secLinkUrl') { 
                if(!item.secondaryLink) item.secondaryLink = {}; item.secondaryLink[ds.key === 'secLinkText' ? 'text' : 'url'] = t.value; 
            }
            else if (ds.m !== undefined) item.menu[ds.m][ds.key] = t.value;
            else if (ds.f !== undefined) item.fields[ds.f][ds.key] = t.value;
            else if (ds.o !== undefined) item.offers[ds.o][ds.key] = t.value;
            else item[ds.key] = t.value;
        });

        document.getElementById('app').addEventListener('change', e => {
            if (e.target.type === 'file') {
                const file = e.target.files[0]; if (!file) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    const ds = e.target.dataset;
                    if (ds.i === undefined) { appData.settings.logoUrl = ev.target.result; }
                    else { if(!appData.categories[ds.c].items[ds.i].images) appData.categories[ds.c].items[ds.i].images = []; appData.categories[ds.c].items[ds.i].images.push(ev.target.result); }
                    render();
                };
                r.readAsDataURL(file);
            }
        });

        document.getElementById('app').addEventListener('click', e => {
            const btn = e.target.closest('button'); if (!btn) return; const ds = btn.dataset;
            if (btn.id === 'add-category') appData.categories.push({ id: `cat-${Date.now()}`, title:'New Tab', icon:'star', type:'grid', items:[] });
            else if (btn.classList.contains('remove-category')) { if(confirm('Delete this category?')) appData.categories.splice(ds.c, 1); }
            else if (btn.classList.contains('add-item')) appData.categories[ds.c].items.push({ name:'New Item', description:'', images:[], fields:[], offers:[], menu:[], link:{text:'',url:''}, secondaryLink:{text:'',url:''} });
            else if (btn.classList.contains('remove-item')) appData.categories[ds.c].items.splice(ds.i, 1);
            else if (btn.classList.contains('add-field')) { if(!appData.categories[ds.c].items[ds.i].fields) appData.categories[ds.c].items[ds.i].fields = []; appData.categories[ds.c].items[ds.i].fields.push({label:'Time', value:'--:--'}); }
            else if (btn.classList.contains('remove-field')) appData.categories[ds.c].items[ds.i].fields.splice(ds.f, 1);
            else if (btn.classList.contains('add-menu')) { if(!appData.categories[ds.c].items[ds.i].menu) appData.categories[ds.c].items[ds.i].menu = []; appData.categories[ds.c].items[ds.i].menu.push({name:'', price:'', description:''}); }
            else if (btn.classList.contains('remove-menu')) appData.categories[ds.c].items[ds.i].menu.splice(ds.m, 1);
            else if (btn.classList.contains('add-offer')) { if(!appData.categories[ds.c].items[ds.i].offers) appData.categories[ds.c].items[ds.i].offers = []; appData.categories[ds.c].items[ds.i].offers.push({title:'Special Deal', description:''}); }
            else if (btn.classList.contains('remove-offer')) appData.categories[ds.c].items[ds.i].offers.splice(ds.o, 1);
            else if (btn.classList.contains('remove-image')) appData.categories[ds.c].items[ds.i].images.splice(ds.img, 1);
            render();
        });

        document.getElementById('save-button').addEventListener('click', async (e) => {
            const btn = e.currentTarget; btn.disabled = true; btn.innerHTML = '<span class="material-icons animate-spin">refresh</span> Saving...';
            try {
                const getRes = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/data.json`, { headers: { 'Authorization': `token ${GITHUB_PAT}` } });
                const sha = (await getRes.json()).sha;
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(appData, null, 2))));
                const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/data.json`, { method: 'PUT', headers: { 'Authorization': `token ${GITHUB_PAT}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: 'Admin Update', content: content, sha: sha }) });
                if (!res.ok) throw new Error('Save failed');
                const notif = document.getElementById('notification'); notif.classList.remove('hidden'); document.getElementById('notification-message').textContent = "Saved Successfully!"; setTimeout(() => notif.classList.add('hidden'), 3000);
            } catch (err) { alert(err.message); } finally { btn.disabled = false; btn.innerHTML = '<span class="material-icons">cloud_upload</span> Push to Live App'; }
        });
    });
    </script>
</body>
</html>
