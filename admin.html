<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Norröna CMS</title>
    <script src="https://cdn.tailwindcss.com"></script><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>body{font-family:'Poppins',sans-serif;background-color:#f3f4f6}.input-field{width:100%;padding:.75rem;border:1px solid #d1d5db;border-radius:.5rem;transition:border-color .2s,box-shadow .2s}.input-field:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.4)}.label{display:block;font-weight:600;color:#374151;margin-bottom:.5rem}.hidden{display:none}#notification{transition:opacity .5s,transform .5s}</style>
</head>
<body>
    <div id="notification" class="hidden fixed top-5 right-5 bg-green-600 text-white py-3 px-5 rounded-lg shadow-lg z-[3000]"><p id="notification-message"></p></div>
    <div id="pat-screen" class="min-h-screen flex items-center justify-center bg-gray-800">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Connect to GitHub</h2>
            <p class="text-center text-gray-500 mb-6">Provide your repository details and Personal Access Token to begin. The token is used for this session only.</p>
            <div class="space-y-4">
                <div><label for="repo-name" class="label">GitHub Repo (e.g., YourUsername/repo-name)</label><input type="text" id="repo-name" class="input-field" value="Kronborg1980/smyril-app"></div>
                <div><label for="pat-input" class="label">Personal Access Token (Classic, with 'repo' scope)</label><input type="password" id="pat-input" class="input-field"></div>
                <button id="connect-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition flex items-center justify-center gap-2"><span class="material-icons">login</span> Connect & Load Data</button>
                <p id="connect-error" class="text-red-500 text-sm text-center pt-2"></p>
            </div>
        </div>
    </div>
    <div id="admin-panel" class="hidden">
        <header class="bg-gray-800 text-white shadow-lg"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4"><h1 class="text-2xl font-bold">Norröna Content Management</h1></div></header>
        <main id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">
            <section><h2 class="text-3xl font-bold text-gray-900 border-b pb-4 mb-6">General Settings</h2><div class="bg-white p-6 rounded-lg shadow-md"><div><label class="label">Header Logo Image</label><div class="flex items-center gap-4"><img id="logo-preview" class="h-10 border p-1 rounded-md bg-gray-800"><input type="file" class="input-field" data-key="logoUrl" accept="image/*"></div></div></div></section>
            <section><h2 class="text-3xl font-bold text-gray-900 border-b pb-4 mb-6">Menu Categories</h2><div id="categories-container" class="space-y-6"></div><button id="add-category" class="mt-6 w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition"><span class="material-icons">add</span>Add New Menu Category</button></section>
        </main>
        <div class="sticky bottom-0 bg-white/80 backdrop-blur-sm p-4 border-t shadow-inner">
            <div class="max-w-7xl mx-auto"><button id="save-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg flex items-center justify-center gap-3"><span class="material-icons">save</span>Save Changes to GitHub</button></div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let GITHUB_USERNAME, GITHUB_REPO, GITHUB_PAT;
            let appData = {};
            const patScreen = document.getElementById("pat-screen");
            const adminPanel = document.getElementById("admin-panel");
            const connectBtn = document.getElementById("connect-btn");
            const connectError = document.getElementById("connect-error");

            connectBtn.addEventListener('click', async () => {
                const repoFullName = document.getElementById('repo-name').value.trim();
                const pat = document.getElementById('pat-input').value.trim();
                connectError.textContent = '';
                connectBtn.disabled = true; connectBtn.innerHTML = 'Connecting...';
                if (!repoFullName || !pat || !repoFullName.includes('/')) {
                    connectError.textContent = 'Repo name and PAT are required. Must be in format: username/repo-name.';
                    connectBtn.disabled = false; connectBtn.innerHTML = '<span class="material-icons">login</span> Connect & Load Data';
                    return;
                }
                [GITHUB_USERNAME, GITHUB_REPO] = repoFullName.split('/');
                GITHUB_PAT = pat;
                try {
                    const response = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/data.json`, { headers: { 'Authorization': `token ${GITHUB_PAT}` }, cache: 'no-cache' });
                    if (!response.ok) throw new Error(`Connection failed. Status: ${response.status}. Check Repo Name and PAT.`);
                    appData = JSON.parse(decodeURIComponent(escape(atob((await response.json()).content))));
                    patScreen.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    render();
                } catch (error) {
                    connectError.textContent = error.message;
                } finally {
                    connectBtn.disabled = false; connectBtn.innerHTML = '<span class="material-icons">login</span> Connect & Load Data';
                }
            });

            const notification = document.getElementById("notification"), notificationMessage = document.getElementById("notification-message");
            function showNotification(message, isError = false) { notificationMessage.textContent = message; notification.classList.remove('hidden', 'bg-green-600', 'bg-red-600'); notification.classList.add(isError ? 'bg-red-600' : 'bg-green-600'); setTimeout(() => { notification.classList.add('hidden'); }, 4000); }
            async function updateGitHubFile(filePath, content, commitMessage) { try { const getFileResponse = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${filePath}`, { headers: { 'Authorization': `token ${GITHUB_PAT}` } }); const fileSha = getFileResponse.ok ? (await getFileResponse.json()).sha : undefined; const updateResponse = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${filePath}`, { method: 'PUT', headers: { 'Authorization': `token ${GITHUB_PAT}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: commitMessage, content: btoa(unescape(encodeURIComponent(content))), sha: fileSha }) }); if (!updateResponse.ok) throw new Error(`Failed to update ${filePath}: ${(await updateResponse.json()).message}`); return true; } catch (error) { showNotification(`Error saving to GitHub: ${error.message}`, true); return false; } }
            document.getElementById('save-button').addEventListener('click', async (e) => { const button = e.currentTarget; button.disabled = true; button.innerHTML = 'Saving...'; const success = await updateGitHubFile('data.json', JSON.stringify(appData, null, 2), "Update content from admin panel"); if (success) { showNotification("Saved to GitHub successfully!"); button.innerHTML = `<span class="material-icons">check_circle</span> Saved!`; } else { button.innerHTML = `<span class="material-icons">error</span> Save Failed`; } setTimeout(() => { button.disabled = false; button.innerHTML = `<span class="material-icons">save</span>Save Changes to GitHub`; }, 3000); });
            function render() {
                document.getElementById("logo-preview").src = appData.settings.logoUrl;
                document.getElementById("categories-container").innerHTML = appData.categories.map((cat, catIndex) => `<div class="bg-white rounded-lg shadow-md"><div class="p-4 bg-gray-50 border-b flex justify-between items-center"><input type="text" class="text-xl font-bold text-gray-800 bg-transparent w-full" value="${cat.title}" placeholder="Category Title" data-cat-index="${catIndex}" data-key="title"><button class="remove-category text-red-500 hover:text-red-700 ml-4" data-cat-index="${catIndex}"><span class="material-icons">delete_forever</span></button></div><div class="p-6 space-y-4">${cat.items.map((item, itemIndex) => `<div class="border rounded-md p-4 bg-gray-50"><div class="flex justify-between items-center mb-4"><input type="text" class="text-lg font-semibold bg-transparent w-full" value="${item.name}" placeholder="Item Name" data-cat-index="${catIndex}" data-item-index="${itemIndex}" data-key="name"><button class="remove-item text-red-500 hover:text-red-700 ml-2" data-cat-index="${catIndex}" data-item-index="${itemIndex}"><span class="material-icons">delete</span></button></div><div class="space-y-4"><div><label class="label text-sm">Description</label><textarea class="input-field text-sm" data-cat-index="${catIndex}" data-item-index="${itemIndex}" data-key="description">${item.description}</textarea></div><div><label class="label text-sm">Images (select multiple)</label><input type="file" class="input-field" data-cat-index="${catIndex}" data-item-index="${itemIndex}" data-key="images" accept="image/*" multiple><div class="flex flex-wrap gap-2 mt-2">${(item.images||[]).map((img, imgIndex) => `<div class="relative"><img src="${img}" class="h-16 w-16 object-cover border rounded-md"><button class="remove-image absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5" data-cat-index="${catIndex}" data-item-index="${itemIndex}" data-img-index="${imgIndex}"><span class="material-icons text-base">close</span></button></div>`).join('')}</div></div><div><h4 class="label text-sm">Custom Fields</h4><div class="space-y-2">${item.fields.map((field, fieldIndex) => `<div class="flex items-center gap-2"><input type="text" class="input-field text-sm" placeholder="Label" value="${field.label}" data-cat-index="${catIndex}" data-item-index="${itemIndex}" data-field-index="${fieldIndex}" data-key="label"><input type="text" class="input-field text-sm" placeholder="Value" value="${field.value}" data-cat-index="${catIndex}" data-item-index="${itemIndex}" data-field-index="${fieldIndex}" data-key="value"><button class="remove-field text-red-500" data-cat-index="${catIndex}" data-item-index="${itemIndex}" data-field-index="${fieldIndex}"><span class="material-icons text-base">remove_circle</span></button></div>`).join('')}</div><button class="add-field mt-2 text-xs font-semibold text-blue-600" data-cat-index="${catIndex}" data-item-index="${itemIndex}">+ Add Field</button></div><div><h4 class="label text-sm">Menu</h4><div class="space-y-2">${(item.menu || []).map((menuItem, menuIndex) => `<div class="grid grid-cols-3 gap-2 border-t pt-2"><input type="text" class="input-field text-sm col-span-2" placeholder="Item Name" value="${menuItem.name}" data-cat-index="${catIndex}" data-item-index="${itemIndex}" data-menu-index="${menuIndex}" data-key="name"><div class="flex items-center gap-2"><input type="text" class="input-field text-sm" placeholder="Price" value="${menuItem.price}" data-cat-index="${catIndex}" data-item-index="${itemIndex}" data-menu-index="${menuIndex}" data-key="price"><button class="remove-menu-item text-red-500" data-cat-index="${catIndex}" data-item-index="${itemIndex}" data-menu-index="${menuIndex}"><span class="material-icons text-base">remove_circle</span></button></div><textarea class="input-field text-sm col-span-3 mt-1" placeholder="Description">${menuItem.description}</textarea></div>`).join('')}</div><button class="add-menu-item mt-2 text-xs font-semibold text-blue-600" data-cat-index="${catIndex}" data-item-index="${itemIndex}">+ Add Menu Item</button></div></div></div>`).join('')}<button class="add-item mt-4 w-full text-blue-600 font-semibold py-2 rounded-md hover:bg-blue-50" data-cat-index="${catIndex}">+ Add New Item to ${cat.title}</button></div></div>`).join('');
            }
            const appContainer = document.getElementById('app');
            appContainer.addEventListener('input', e => { const target = e.target; if (target.matches('input, textarea')) { const { catIndex, itemIndex, fieldIndex, menuIndex, key } = target.dataset; if (catIndex === undefined) return; const value = target.value; if (itemIndex === undefined) appData.categories[catIndex][key] = value; else if (menuIndex !== undefined) appData.categories[catIndex].items[itemIndex].menu[menuIndex][key] = value; else if (fieldIndex === undefined) appData.categories[catIndex].items[itemIndex][key] = value; else appData.categories[catIndex].items[itemIndex].fields[fieldIndex][key] = value; } });
            appContainer.addEventListener('change', e => { if (e.target.matches('input[type="file"]')) { const files = e.target.files; if (!files.length) return; const { catIndex, itemIndex } = e.target.dataset; if (catIndex === undefined) { const reader = new FileReader(); reader.onload = (event) => { appData.settings.logoUrl = event.target.result; render(); }; reader.readAsDataURL(files[0]); } else { const item = appData.categories[catIndex].items[itemIndex]; if(!item.images) item.images = []; Array.from(files).forEach(file => { const reader = new FileReader(); reader.onload = (event) => { item.images.push(event.target.result); render(); }; reader.readAsDataURL(file); }); } } });
            appContainer.addEventListener('click', e => { const target = e.target.closest('button'); if (!target) return; const { catIndex, itemIndex, fieldIndex, menuIndex, imgIndex } = target.dataset; if (target.matches('#add-category')) appData.categories.push({ id: `category-${Date.now()}`, title: 'New Category', items: [] }); else if (target.matches('.remove-category')) { if (confirm('Are you sure?')) appData.categories.splice(catIndex, 1); } else if (target.matches('.add-item')) appData.categories[catIndex].items.push({ id: `item-${Date.now()}`, name: 'New Item', description: '', images: [], fields: [], menu: [] }); else if (target.matches('.remove-item')) appData.categories[catIndex].items.splice(itemIndex, 1); else if (target.matches('.add-field')) appData.categories[catIndex].items[itemIndex].fields.push({ label: '', value: '' }); else if (target.matches('.remove-field')) appData.categories[catIndex].items[itemIndex].fields.splice(fieldIndex, 1); else if (target.matches('.remove-image')) appData.categories[catIndex].items[itemIndex].images.splice(imgIndex, 1); else if (target.matches('.add-menu-item')) { if (!appData.categories[catIndex].items[itemIndex].menu) appData.categories[catIndex].items[itemIndex].menu = []; appData.categories[catIndex].items[itemIndex].menu.push({ name: '', description: '', price: '' }); } else if (target.matches('.remove-menu-item')) appData.categories[catIndex].items[itemIndex].menu.splice(menuIndex, 1); render(); });
        });
    </script>
</body>
</html>
