<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"><title>Norröna Guide</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        :root { --primary: #00f3ff; --bg: #050b14; --panel: rgba(16, 30, 48, 0.9); --text: #fff; --dim: rgba(255,255,255,0.6); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; }
        
        /* Utilities */
        .neon { color: var(--primary); text-shadow: 0 0 12px rgba(0, 243, 255, 0.4); }
        .glass { background: var(--panel); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; }
        .hidden { display: none; }

        /* Nav */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: #0f172a; border-radius: 40px; display: flex; justify-content: space-around; padding: 12px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 9999; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; color: var(--dim); text-decoration: none; font-size: 10px; transition: 0.3s; }
        .nav-btn.active { color: var(--primary); transform: translateY(-4px); }
        .nav-btn span { font-size: 24px; margin-bottom: 2px; }

        /* Content */
        .page { padding: 20px; display: none; animation: fade 0.4s ease; }
        .page.active { display: block; }
        @keyframes fade { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        
        .hero { height: 40vh; position: relative; border-radius: 24px; overflow: hidden; margin-bottom: 24px; }
        .hero img { width: 100%; height: 100%; object-fit: cover; }
        .hero-content { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(transparent, #000); padding: 24px; }

        /* Items */
        .item-card { margin-bottom: 30px; overflow: hidden; }
        .item-img { height: 180px; width: 100%; object-fit: cover; border-radius: 16px; margin-bottom: 12px; display: block; }
        .meta-row { display: flex; gap: 15px; margin: 10px 0; font-size: 0.9rem; color: var(--dim); }
        .meta-item { display: flex; align-items: center; gap: 5px; }
        
        /* Sub Lists (Menu vs Catalog) */
        .sub-list-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); margin: 20px 0 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        
        .menu-list .menu-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .menu-item .info { flex: 1; }
        .menu-item .title { font-weight: 500; font-size: 1rem; }
        .menu-item .sub { font-size: 0.85rem; color: var(--dim); }
        .menu-item .price { font-weight: 700; color: var(--primary); margin-left: 10px; }

        .catalog-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .catalog-item { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; text-align: center; }
        .catalog-item img { width: 100%; height: 100px; object-fit: contain; margin-bottom: 8px; }
        .catalog-item .price { display: block; color: var(--primary); font-weight: 700; margin-top: 4px; }

        .action-btn { display: block; width: 100%; background: var(--primary); color: #000; text-align: center; padding: 12px; border-radius: 12px; font-weight: 700; text-decoration: none; margin-top: 15px; }

        /* Map & Stats */
        #map { height: 50vh; width: 100%; border-radius: 24px; margin-bottom: 20px; background: #111; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-val { font-size: 1.5rem; font-weight: 700; }
        .stat-lbl { font-size: 0.75rem; color: var(--dim); text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>
    <main id="app-container"></main>
    <nav class="bottom-nav" id="nav-container"></nav>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", async () => {
        let appData = {}, map = null;
        
        // --- Init ---
        try {
            const res = await fetch("data.json?v=" + Date.now());
            if(!res.ok) throw new Error("No Data");
            appData = await res.json();
            initApp();
        } catch(e) {
            document.body.innerHTML = `<div style="padding:40px;text-align:center;color:red">App Data missing. Please Connect GitHub in Admin.</div>`;
        }

        function initApp() {
            // 1. Build Nav
            const navHTML = appData.categories.map(cat => 
                `<a href="#${cat.id}" class="nav-btn" data-id="${cat.id}" onclick="renderPage('${cat.id}')">
                    <span class="material-icons">${cat.icon}</span>${cat.title}
                 </a>`
            ).join('');
            document.getElementById('nav-container').innerHTML = navHTML;
            
            // 2. Load initial page
            const hash = window.location.hash.replace('#','') || appData.categories[0].id;
            renderPage(hash);
            setInterval(updateLiveStats, 30000); // Live ship updates
        }

        // --- Rendering System ---
        window.renderPage = (pageId) => {
            const cat = appData.categories.find(c => c.id === pageId);
            if(!cat) return;

            // Active Nav State
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.id === pageId));

            const container = document.getElementById('app-container');
            
            // A. Voyage Layout
            if(cat.type === 'voyage') {
                container.innerHTML = `
                    <div class="page active">
                        <h2 class="text-center mb-4 neon">Live Tracking</h2>
                        <div id="map"></div>
                        <div class="stat-grid">
                            <div class="stat-box"><div class="stat-val neon" id="stat-speed">--</div><div class="stat-lbl">Knots</div></div>
                            <div class="stat-box"><div class="stat-val" id="stat-dist">--</div><div class="stat-lbl">Dist (km)</div></div>
                            <div class="stat-box" style="grid-column:span 2"><div class="stat-val" id="stat-eta">--</div><div class="stat-lbl">Next Stop</div></div>
                        </div>
                    </div>`;
                setTimeout(initMap, 100);
                return;
            }

            // B. Home Layout
            if(cat.type === 'home') {
                const hero = cat.items[0];
                container.innerHTML = `
                    <div class="page active">
                        <div class="hero">
                            <img src="${hero.images[0]}">
                            <div class="hero-content">
                                <h1 style="font-size:2.5rem;line-height:1">${hero.name}</h1>
                                <p style="color:var(--primary)">${hero.description}</p>
                            </div>
                        </div>
                        <div class="stat-grid">
                            <div class="stat-box"><div class="stat-val neon" id="home-speed">--</div><div class="stat-lbl">Speed</div></div>
                            <div class="stat-box"><div class="stat-val" id="home-temp">--°</div><div class="stat-lbl">Outside</div></div>
                        </div>
                    </div>`;
                updateLiveStats();
                return;
            }

            // C. Standard Grid (The "Everything Thinkable" Render)
            const itemsHTML = cat.items.map(item => `
                <div class="item-card glass p-4">
                    ${item.images && item.images.length && item.images[0] ? `<img src="${item.images[0]}" class="item-img">` : ''}
                    <h2 class="text-xl font-bold">${item.name}</h2>
                    <p class="text-sm text-dim mt-1">${item.description || ''}</p>
                    
                    <div class="meta-row">
                        ${item.location ? `<div class="meta-item"><span class="material-icons text-sm">place</span>${item.location}</div>` : ''}
                        ${item.openingHours && item.openingHours.length ? `<div class="meta-item"><span class="material-icons text-sm">schedule</span>${item.openingHours[0].split(':')[0]}...</div>` : ''}
                    </div>

                    ${renderSubList(item)}

                    ${item.actionButton && item.actionButton.url ? `<a href="${item.actionButton.url}" class="action-btn">${item.actionButton.text || 'View More'}</a>` : ''}
                </div>
            `).join('');

            container.innerHTML = `<div class="page active"><h1 class="text-2xl font-bold mb-4 px-2">${cat.title}</h1>${itemsHTML}</div>`;
        };

        function renderSubList(item) {
            if(!item.subList || !item.subList.length) return '';
            
            const html = item.subListType === 'catalog' 
                // 1. Catalog Grid (Images + Price)
                ? `<div class="sub-list-title">Catalog</div><div class="catalog-grid">
                    ${item.subList.map(s => `<div class="catalog-item">${s.image?`<img src="${s.image}">`:''}<div class="text-sm font-medium">${s.title}</div><span class="price">${s.price}</span></div>`).join('')}
                   </div>`
                // 2. Menu List (Text + Price)
                : `<div class="sub-list-title">Menu / Info</div><div class="menu-list">
                    ${item.subList.map(s => `<div class="menu-item"><div class="info"><div class="title">${s.title}</div><div class="sub">${s.subtitle||''}</div></div><div class="price">${s.price||''}</div></div>`).join('')}
                   </div>`;
            return html;
        }

        // --- Live Data Logic (Same as before, abbreviated for brevity) ---
        async function updateLiveStats() {
            try {
                const res = await fetch("https://smyrillinewebapi-cec3fkhjh8bbhtd3.northeurope-01.azurewebsites.net/vessel/vessels");
                const ship = (await res.json()).find(v => v.vesselName.toUpperCase() === 'NORRONA');
                if(ship) {
                    if(document.getElementById('stat-speed')) document.getElementById('stat-speed').innerText = ship.position.speed;
                    if(document.getElementById('home-speed')) document.getElementById('home-speed').innerText = ship.position.speed;
                    // More API mapping here...
                }
            } catch(e) {}
        }

        function initMap() {
            if(map) map.remove();
            map = L.map('map', {zoomControl:false, attributionControl:false}).setView([62.00, -6.76], 6);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            // Add Ship marker logic here...
        }
    });
    </script>
</body>
</html>
