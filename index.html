<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Norröna Onboard Guide</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        :root {
            --neon-cyan: #00f2ff;
            --neon-blue: #0051ff;
            --deep-bg: #020b14;
            --glass-surface: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.5);
            --card-radius: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--deep-bg);
            color: var(--text-main);
            background-image: radial-gradient(circle at 50% 0%, #0f2e4e 0%, var(--deep-bg) 60%);
            background-attachment: fixed;
            min-height: 100vh;
        }

        #app-shell {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 90px;
            position: relative;
            overflow-x: hidden;
        }

        /* --- Header --- */
        .main-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(2, 11, 20, 0.7);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding-top: env(safe-area-inset-top);
        }
        .navbar { display: flex; justify-content: space-between; align-items: center; height: 60px; padding: 0 24px; }
        /* Updated Logo Style */
        .navbar .logo img { height: 40px; width: auto; object-fit: contain; filter: drop-shadow(0 0 8px rgba(255,255,255,0.2)); }
        .onboard-time { font-weight: 700; font-size: 0.95rem; letter-spacing: 1px; text-shadow: 0 0 10px var(--neon-cyan); color: var(--neon-cyan); }

        /* --- Layout --- */
        .page { padding: 24px; display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-header { margin-bottom: 24px; }
        .section-header h2 { font-size: 2rem; font-weight: 700; background: linear-gradient(to right, #fff, #a5b4fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- Cards --- */
        .item-card {
            background: var(--glass-surface); border: 1px solid var(--glass-border); border-radius: var(--card-radius);
            overflow: hidden; margin-bottom: 24px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px);
        }
        .image-container { width: 100%; height: 220px; background: #000; position: relative; }
        .item-card-image { width: 100%; height: 100%; object-fit: cover; }
        .item-info { padding: 24px; }
        .item-info h3 { font-size: 1.4rem; font-weight: 600; margin-bottom: 8px; color: #fff; }
        .item-info p { color: var(--text-muted); font-size: 0.95rem; line-height: 1.5; margin-bottom: 16px; }
        .fields { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px; margin-top: 16px; display: grid; gap: 12px; }
        .field { display: flex; justify-content: space-between; font-size: 0.9rem; }
        .field strong { color: var(--neon-cyan); font-weight: 500; }
        .field span { color: #fff; }
        .item-link-button {
            display: block; background: linear-gradient(135deg, var(--neon-blue), var(--neon-cyan)); color: #000;
            text-align: center; padding: 14px; border-radius: 12px; text-decoration: none; font-weight: 700; margin-top: 24px;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
        }
        
        /* --- Slideshow --- */
        .slideshow { position: relative; width: 100%; height: 100%; }
        .slide { position: absolute; inset: 0; opacity: 0; transition: opacity 0.5s; }
        .slide.active { opacity: 1; }
        .slide img { width: 100%; height: 100%; object-fit: cover; }
        .slideshow-dots { position: absolute; bottom: 12px; left: 0; right: 0; display: flex; justify-content: center; gap: 8px; }
        .dot { width: 6px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 50%; }
        .dot.active { background: var(--neon-cyan); box-shadow: 0 0 8px var(--neon-cyan); }

        /* --- Home & Voyage --- */
        .home-hero {
            height: 55vh; display: flex; flex-direction: column; justify-content: flex-end; padding: 30px;
            background-size: cover; background-position: center; position: relative; border-radius: 0 0 30px 30px; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .home-hero::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, var(--deep-bg) 0%, rgba(2,11,20,0.2) 50%, transparent 100%); }
        .home-hero-content { position: relative; z-index: 2; }
        .home-hero h1 { font-size: 3rem; line-height: 1; font-weight: 700; margin-bottom: 10px; text-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        
        .voyage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 24px 0; }
        .grid-item { background: var(--glass-surface); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; text-align: left; }
        .grid-item .label { font-size: 0.75rem; color: var(--neon-cyan); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
        .grid-item .value { font-size: 1.4rem; font-weight: 600; line-height: 1.1; color: #fff; display: flex; align-items: baseline; gap: 6px; }
        .grid-item .value .unit { font-size: 0.7em; opacity: 0.7; font-weight: 400; }
        .grid-item .sub-value { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
        
        #map { width: 100%; height: 45vh; border-radius: 0 0 24px 24px; margin-bottom: 20px; box-shadow: inset 0 -20px 40px var(--deep-bg); }
        .weather-panel {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
            border: 1px solid var(--glass-border); border-radius: 24px; padding: 20px;
            display: flex; align-items: center; gap: 20px; margin-top: 10px;
        }
        .weather-panel img { width: 50px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.4)); }

        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px; max-width: 440px; margin: 0 auto; height: 70px;
            background: rgba(10, 20, 35, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 35px;
            display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); text-decoration: none; font-size: 0.7rem; transition: 0.3s; width: 60px; }
        .nav-item .material-icons { font-size: 24px; margin-bottom: 4px; transition: 0.3s; }
        .nav-item.active { color: #fff; }
        .nav-item.active .material-icons { color: var(--neon-cyan); text-shadow: 0 0 15px var(--neon-cyan); transform: translateY(-5px); }
    </style>
</head>
<body>
    <div id="app-shell">
        <header class="main-header">
            <nav class="navbar">
                <a href="#" class="logo"><img id="header-logo" src="" alt="Logo"></a>
                <div class="onboard-time" id="onboard-time-header">--:--</div>
            </nav>
        </header>
        <main id="content-container"></main>
    </div>
    <nav class="bottom-nav" id="bottom-nav"></nav>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const contentContainer = document.getElementById("content-container");
            let appData = {};
            let map;
            let liveRouteLine = null; // Variable to store the dynamic line
            
            const destIcon = L.icon({
                iconUrl: "https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",
                iconSize: [12, 20], iconAnchor: [6, 20]
            });

            function createImageArea(images) {
                if (!Array.isArray(images) || images.length === 0) return `<div class="image-container" style="display:none"></div>`;
                if (images.length === 1) return `<div class="image-container"><img src="${images[0]}" class="item-card-image" loading="lazy"></div>`;
                const slides = images.map((img, i) => `<div class="slide ${i === 0 ? 'active' : ''}"><img src="${img}"></div>`).join('');
                const dots = images.map((_, i) => `<div class="dot ${i === 0 ? 'active' : ''}"></div>`).join('');
                return `<div class="image-container"><div class="slideshow" data-total="${images.length}">${slides}<div class="slideshow-nav"><button class="prev">&lt;</button><button class="next">&gt;</button></div><div class="slideshow-dots">${dots}</div></div></div>`;
            }

            function createMenu(menuItems) {
                if (!Array.isArray(menuItems) || menuItems.length === 0) return '';
                return `<div class="menu"><h4>Menu Highlights</h4>${menuItems.map(item => `<div class="menu-item"><div class="menu-item-header"><span>${item.name}</span><span>${item.price}</span></div>${item.description ? `<div class="menu-item-desc">${item.description}</div>` : ''}</div>`).join('')}</div>`;
            }

            function initializeSlideshows() {
                document.querySelectorAll('.slideshow').forEach(slideshow => {
                    let currentIndex = 0;
                    const slides = slideshow.querySelectorAll('.slide'), dots = slideshow.querySelectorAll('.dot'), total = slides.length;
                    function showSlide(index) {
                        slides.forEach(s => s.classList.remove('active'));
                        dots.forEach(d => d.classList.remove('active'));
                        slides[index].classList.add('active');
                        dots[index].classList.add('active');
                        currentIndex = index;
                    }
                    slideshow.querySelector('.next').addEventListener('click', (e) => { e.preventDefault(); showSlide((currentIndex + 1) % total)});
                    slideshow.querySelector('.prev').addEventListener('click', (e) => { e.preventDefault(); showSlide((currentIndex - 1 + total) % total)});
                });
            }

            function renderPage(pageId) {
                const page = appData.categories.find(cat => cat.id === pageId);
                if (!page) { contentContainer.innerHTML = '<p style="padding:20px">Page not found.</p>'; return; }
                
                document.querySelectorAll('.nav-item').forEach(link => link.classList.toggle('active', link.dataset.id === pageId));
                
                if (page.type === 'home') {
                    const heroItem = page.items[0] || { images:[], name:'', description:'' };
                    contentContainer.innerHTML = `
                        <div class="page active" style="padding:0;">
                            <div class="home-hero" style="background-image: url(${heroItem.images[0] || ''})">
                                <div class="home-hero-content">
                                    <h1>${heroItem.name}</h1>
                                    <p>${heroItem.description}</p>
                                </div>
                            </div>
                            <div style="padding:24px;">
                                <div class="voyage-grid">
                                    <div class="grid-item">
                                        <div id="home-dest-label" class="label">Next Stop</div>
                                        <div class="value" id="destination-home" style="font-size:1.6rem">--</div>
                                        <div class="sub-value" id="eta-home">--</div>
                                    </div>
                                    <div class="grid-item">
                                        <div class="label">Speed & Course</div>
                                        <div class="value" style="font-size: 1.2rem;">
                                            <span id="speed-knots-home">--</span> <span class="unit">|</span> <span id="speed-kmh-home">--</span>
                                        </div>
                                        <div class="sub-value" id="course-home">Course: --°</div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    updateShipData(true);
                } else if (page.type === 'voyage') {
                    contentContainer.innerHTML = `
                        <div class="page active voyage-page" style="padding:0">
                            <div id="map"></div>
                            <div style="padding:0 24px 24px 24px;">
                                <div class="voyage-grid">
                                    <div class="grid-item">
                                        <div class="label">Speed & Course</div>
                                        <div class="value" style="font-size: 1.2rem;">
                                            <span id="speed-knots">--</span> <span class="unit">|</span> <span id="speed-kmh">--</span>
                                        </div>
                                        <div class="sub-value" id="course-voyage">Course: --°</div>
                                    </div>
                                    <div class="grid-item">
                                        <div class="label">Time (Tórshavn)</div>
                                        <div class="value" id="onboard-time" style="font-size:1.6rem">--:--</div>
                                        <div class="sub-value">GMT</div>
                                    </div>
                                    <div class="grid-item">
                                        <div class="label">Distance Left</div>
                                        <div class="value" id="distance" style="font-size:1.6rem">--</div>
                                        <div class="sub-value" id="distance-unit">Kilometers</div>
                                    </div>
                                    <div class="grid-item">
                                        <div class="label" id="destination-label">Next Destination</div>
                                        <div class="value" id="destination-voyage" style="font-size:1.6rem">--</div>
                                        <div class="sub-value" id="eta-voyage">--</div>
                                    </div>
                                </div>
                                <div class="weather-panel">
                                    <img id="weather-icon" src="" alt="">
                                    <div class="weather-info">
                                        <div class="label" style="color:var(--neon-cyan)">Weather at Destination</div>
                                        <div class="value" style="font-size:1.2rem"><span id="weather-temp">--°C</span>, <span id="weather-description">--</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    initializeVoyagePage();
                } else {
                    contentContainer.innerHTML = `
                        <div class="page active">
                            <div class="section-header"><h2>${page.title}</h2></div>
                            <div class="content-grid">
                                ${page.items.map(item => `
                                    <div class="item-card">
                                        ${createImageArea(item.images)}
                                        <div class="item-info">
                                            <h3>${item.name}</h3>
                                            ${item.description ? `<p>${item.description}</p>` : ''}
                                            ${(item.fields || []).length > 0 ? `<div class="fields">${item.fields.map(f => `<div class="field"><strong>${f.label}</strong><span>${f.value}</span></div>`).join('')}</div>` : ''}
                                            ${createMenu(item.menu)}
                                            ${item.link && item.link.url ? `<a href="${item.link.url}" target="_blank" class="item-link-button">${item.link.text}</a>` : ''}
                                        </div>
                                    </div>`).join('')}
                            </div>
                        </div>`;
                    initializeSlideshows();
                }
                window.location.hash = pageId;
            }

            async function init() {
                try {
                    const response = await fetch("data.json?v=" + Date.now());
                    if (!response.ok) throw new Error("Could not load data.");
                    appData = await response.json();
                    document.getElementById("header-logo").src = appData.settings.logoUrl;
                    const navHtml = appData.categories.map(cat => 
                        `<a href="#${cat.id}" class="nav-item" data-id="${cat.id}">
                            <span class="material-icons">${cat.icon}</span>${cat.title}
                         </a>`).join('');
                    document.getElementById("bottom-nav").innerHTML = navHtml;
                    document.querySelectorAll('.nav-item').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            renderPage(e.currentTarget.dataset.id);
                        });
                    });
                    const initialPageId = window.location.hash.substring(1) || appData.categories[0]?.id;
                    if (initialPageId) renderPage(initialPageId);
                } catch (error) { console.error(error); contentContainer.innerHTML = `<p>${error.message}</p>`; }
            }

            function updateHeaderTime() { document.getElementById('onboard-time-header').textContent = new Date().toLocaleTimeString('en-GB', { timeZone: 'Atlantic/Faroe', hour: '2-digit', minute: '2-digit' }); }
            const destinationMap = { torshavn: { name: "Tórshavn", country: "FO", lat: 62.01, lon: -6.771 }, hirtshals: { name: "Hirtshals", country: "DK", lat: 57.594, lon: 9.965 }, seydisfjord: { name: "Seyðisfjörður", country: "IS", lat: 65.262, lon: -14.012 } };
            
            function normalizeDestinationName(e) { return e ? e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ð/g, "d").replace(/[^a-z0-9]/g, "") : "" }
            function haversineDistance(e,t,o,a){const n=6371,r=(o-e)*Math.PI/180,i=(a-t)*Math.PI/180,s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 2*n*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))}
            function formatETA(e) { if (!e) return { day: "--", time: "--:--" }; try { const t = new Date(e); if (isNaN(t.getTime())) return { day: "Inv", time: "" }; const o = t.toLocaleDateString("en-GB", { weekday: "short", timeZone: "Atlantic/Faroe" }), a = t.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", hour12: !1, timeZone: "Atlantic/Faroe" }); return { day: o, time: a } } catch (e) { return { day: "Err", time: "" } } }
            
            async function fetchWeatherData(lat, lon) {
                 try {
                    const apiKey = 'AIzaSyAAXsfnLWGjbcz4RGlERJwo3Y0Soe56ryI';
                    const url = `https://weather.googleapis.com/v1/currentConditions:lookup?key=${apiKey}&location.latitude=${lat}&location.longitude=${lon}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error("Weather Fail");
                    const data = await response.json();
                    const tempEl = document.getElementById("weather-temp");
                    if (tempEl) tempEl.textContent = data.temperature?.degrees != null ? `${Math.round(data.temperature.degrees)}°C` : '--°C';
                    const descEl = document.getElementById("weather-description");
                    if (descEl) descEl.textContent = data.weatherCondition?.description?.text || "N/A";
                    const weatherIconEl = document.getElementById("weather-icon");
                    if (weatherIconEl) weatherIconEl.src = `https://openweathermap.org/img/wn/02d@2x.png`;
                } catch (e) { console.log("Weather error"); }
            }

            async function updateShipData(isHomePage = false) {
                try {
                    const response = await fetch("https://smyrillinewebapi-cec3fkhjh8bbhtd3.northeurope-01.azurewebsites.net/vessel/vessels");
                    const norrona = (await response.json()).find(v => v.vesselName?.toUpperCase() === 'NORRONA');
                    if (!norrona) return;
                    const speedKnots = norrona.position?.speed || 0;
                    const course = Math.round(norrona.position?.course || 0);
                    
                    const currentDestKey = normalizeDestinationName(norrona.destinationFromAIS.split(",")[0].trim());
                    const currentDestInfo = destinationMap[currentDestKey] || destinationMap['torshavn'];
                    const { day, time } = formatETA(norrona.etaFromAIS);

                    if (isHomePage) {
                        document.getElementById('destination-home').textContent = currentDestInfo.name;
                        document.getElementById('eta-home').textContent = `${day}, ${time}`;
                        document.getElementById('speed-knots-home').textContent = `${speedKnots} kn`;
                        document.getElementById('speed-kmh-home').textContent = `${(speedKnots * 1.852).toFixed(1)} km/h`;
                        document.getElementById('course-home').textContent = `Course: ${course}°`;
                    } else {
                         const page = document.querySelector('.voyage-page'); if(!page) return;
                         document.getElementById("speed-knots").textContent = `${speedKnots} kn`;
                         document.getElementById("speed-kmh").textContent = `${(speedKnots * 1.852).toFixed(1)} km/h`;
                         document.getElementById("course-voyage").textContent = `Course: ${course}°`;

                         const dist = haversineDistance(norrona.position.latitude, norrona.position.longitude, currentDestInfo.lat, currentDestInfo.lon);
                         document.getElementById("distance").textContent = Math.round(dist);
                         document.getElementById("destination-voyage").textContent = currentDestInfo.name;
                         document.getElementById("eta-voyage").textContent = `${day} ${time}`;
                         document.getElementById("onboard-time").textContent = new Date().toLocaleTimeString("en-GB", { timeZone: "Atlantic/Faroe", hour: "2-digit", minute: "2-digit" });
                         
                         if (map) {
                            const shipPos = [norrona.position.latitude, norrona.position.longitude];
                            const destPos = [currentDestInfo.lat, currentDestInfo.lon];
                            
                            // Draw Markers
                            if (!map.shipMarker) { map.shipMarker = L.marker(shipPos, { icon: destIcon }).addTo(map); } else { map.shipMarker.setLatLng(shipPos); }
                            if (!map.destMarker) { map.destMarker = L.marker(destPos, { icon: destIcon }).addTo(map); } else { map.destMarker.setLatLng(destPos); }
                            
                            // *** LOGIC TO DRAW LINE FROM SHIP TO DESTINATION ***
                            // Remove old dynamic line if it exists
                            if (liveRouteLine) { map.removeLayer(liveRouteLine); }
                            
                            // Create new line from Ship GPS -> Destination GPS
                            liveRouteLine = L.polyline([shipPos, destPos], {
                                color: '#00f2ff', // Neon Cyan color for the active line
                                weight: 3,
                                dashArray: '10, 10',
                                opacity: 0.9
                            }).addTo(map);

                            // Center map to show both points
                            map.fitBounds(L.latLngBounds(shipPos, destPos), { padding: [50, 50] });
                         }
                         fetchWeatherData(currentDestInfo.lat, currentDestInfo.lon);
                    }
                } catch(e) { console.log(e); }
            }

            function initializeVoyagePage() {
                if (map) { map.remove(); map = null; }
                map = L.map("map", { zoomControl: !1, attributionControl: !1, renderer: L.canvas() }).setView([60.0, -2.0], 5);
                L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { attribution: "", subdomains: "abcd" }).addTo(map);
                
                // Keep the background route for context, but make it fainter
                const detailedRoute = [
                    [57.59, 9.96], [57.80, 8.90], [58.20, 5.50], [59.50, 2.00],
                    [60.85, -0.83], [61.50, -3.50], [62.01, -6.77], [62.50, -8.00],
                    [64.00, -11.50], [65.10, -13.00], [65.26, -14.01]
                ];
                L.polyline(detailedRoute, {
                    color: '#ffffff', weight: 1, dashArray: '5, 15', opacity: 0.2
                }).addTo(map);
                
                updateShipData();
            }

            setInterval(updateShipData, 60000);
            setInterval(updateHeaderTime, 1000);
            init();
        });
    </script>
</body>
</html>
