<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"><title>Norröna Onboard Guide</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>:root{--smyril-blue:#002B5C;--smyril-accent:#00A9E0;--background-dark:#011832;--glass-bg:rgba(0, 25, 53, 0.6);--text-light:#ffffff;--text-muted:rgba(255, 255, 255, 0.6);--border-radius:16px}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Poppins',sans-serif;background-color:var(--background-dark);color:var(--text-light);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}#app-shell{max-width:500px;margin:0 auto;background-color:var(--background-dark);min-height:100vh;display:flex;flex-direction:column;padding-bottom:70px}.main-header{position:sticky;top:0;z-index:1000;background:var(--glass-bg);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.1)}.navbar{display:flex;justify-content:space-between;align-items:center;height:60px;padding:0 20px}.navbar .logo img{height:24px}.onboard-time{font-weight:600;font-size:.9rem}main{flex-grow:1}.page{padding:20px;display:none}.page.active{display:block}.section-header{margin-bottom:20px;text-align:center}.section-header h2{font-size:2rem;font-weight:700;color:var(--text-light)}.item-card{background:var(--glass-bg);border:1px solid rgba(255,255,255,0.1);border-radius:var(--border-radius);box-shadow:0 8px 30px rgba(0,0,0,.2);overflow:hidden;margin-bottom:20px;opacity:0;transform:translateY(20px);transition:opacity .5s,transform .5s}.item-card.visible{opacity:1;transform:translateY(0)}.image-container{width:100%;height:200px;background:#00152b}.item-card-image{width:100%;height:100%;object-fit:cover;display:block}.item-info{padding:20px}.item-info h3{font-size:1.3rem;font-weight:600}.item-info p{color:var(--text-muted);margin:8px 0;font-size:.9rem}.item-info .fields{border-top:1px solid rgba(255,255,255,.1);margin-top:15px;padding-top:15px;display:grid;gap:8px;font-size:.9rem}.item-info .field{display:flex;justify-content:space-between}.item-info .field strong{color:var(--text-light);font-weight:600}.item-link-button{display:block;background-color:var(--smyril-accent);color:var(--text-dark);text-align:center;padding:12px;border-radius:8px;text-decoration:none;font-weight:600;margin-top:20px;transition:transform .2s ease}.item-link-button:hover{transform:scale(1.05)}.menu{border-top:1px solid rgba(255,255,255,.1);margin-top:15px;padding-top:15px}.menu h4{font-weight:700;color:var(--smyril-accent);margin-bottom:10px}.menu-item{margin-bottom:10px;font-size:.9rem}.menu-item-header{display:flex;justify-content:space-between;font-weight:600}.menu-item-desc{font-size:.8rem;color:var(--text-muted)}.slideshow{position:relative;width:100%;height:100%;overflow:hidden}.slide{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;transition:opacity .5s ease-in-out}.slide.active{opacity:1}.slide img{width:100%;height:100%;object-fit:cover}#map{width:100%;height:40vh;border-bottom:1px solid rgba(255,255,255,.1)}.leaflet-container{background-color:#1a1a1a}.voyage-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:20px 0}.grid-item{background:var(--glass-bg);border:1px solid rgba(255,255,255,0.1);border-radius:var(--border-radius);padding:20px;text-align:center}.grid-item .label{font-size:.8rem;color:var(--smyril-accent);margin-bottom:8px;text-transform:uppercase}.grid-item .value{font-size:1.5rem;font-weight:700}.grid-item .sub-value{font-size:.8rem;color:var(--text-muted)}.weather-panel{background:var(--glass-bg);border:1px solid rgba(255,255,255,0.1);border-radius:var(--border-radius);padding:20px;display:flex;align-items:center;gap:20px}.weather-panel img{width:60px;height:60px}.weather-info .label{font-size:.8rem;color:var(--smyril-accent);text-transform:uppercase}.weather-info .value{font-size:1.2rem;font-weight:700}
        .home-hero{height:50vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;background-size:cover;background-position:center;position:relative}.home-hero::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to top,var(--background-dark) 0%,rgba(0,0,0,0.3) 100%)}.home-hero *{position:relative;z-index:2}.home-hero h1{font-size:2.5rem}.home-hero p{font-size:1.1rem;color:var(--text-muted)}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:500px;margin:0 auto;height:70px;background:var(--glass-bg);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-around;align-items:center;z-index:1000}
        .nav-item{display:flex;flex-direction:column;align-items:center;color:var(--text-muted);text-decoration:none;font-size:.7rem;transition:color .2s ease}.nav-item.active{color:var(--smyril-accent)}.nav-item .material-icons{font-size:24px;margin-bottom:2px}
    </style>
</head>
<body>
    <div id="app-shell">
        <header class="main-header">
            <nav class="navbar">
                <a href="#" class="logo"><img id="header-logo" src="" alt="Logo"></a>
                <div class="onboard-time" id="onboard-time-header">--:--</div>
            </nav>
        </header>
        <main id="content-container"></main>
    </div>
    <nav class="bottom-nav" id="bottom-nav"></nav>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const contentContainer = document.getElementById("content-container");
            let appData = {};
            let map;
            // Define destination marker icon
            const destIcon = L.icon({
                iconUrl: "https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",
                iconSize: [12, 20],
                iconAnchor: [6, 20]
            });
            function createImageArea(images) { if (!Array.isArray(images) || images.length === 0) return `<div class="image-container"></div>`; if (images.length === 1) return `<div class="image-container"><img src="${images[0]}" class="item-card-image" loading="lazy"></div>`; const slides = images.map((img, i) => `<div class="slide ${i === 0 ? 'active' : ''}"><img src="${img}"></div>`).join(''); const dots = images.map((_, i) => `<div class="dot ${i === 0 ? 'active' : ''}"></div>`).join(''); return `<div class="image-container"><div class="slideshow" data-total="${images.length}">${slides}<div class="slideshow-nav"><button class="prev">&lt;</button><button class="next">&gt;</button></div><div class="slideshow-dots">${dots}</div></div></div>`; }
            function createMenu(menuItems) { if (!Array.isArray(menuItems) || menuItems.length === 0) return ''; return `<div class="menu"><h4>Menu</h4>${menuItems.map(item => `<div class="menu-item"><div class="menu-item-header"><span>${item.name}</span><span>${item.price}</span></div>${item.description ? `<div class="menu-item-desc">${item.description}</div>` : ''}</div>`).join('')}</div>`; }
            function initializeSlideshows() { document.querySelectorAll('.slideshow').forEach(slideshow => { let currentIndex = 0; const slides = slideshow.querySelectorAll('.slide'), dots = slideshow.querySelectorAll('.dot'), total = slides.length; function showSlide(index) { slides.forEach(s => s.classList.remove('active')); dots.forEach(d => d.classList.remove('active')); slides[index].classList.add('active'); dots[index].classList.add('active'); currentIndex = index; } slideshow.querySelector('.next').addEventListener('click', () => showSlide((currentIndex + 1) % total)); slideshow.querySelector('.prev').addEventListener('click', () => showSlide((currentIndex - 1 + total) % total)); }); }
            function animateVisibleItems() { const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('visible'); observer.unobserve(entry.target); } }); }, { threshold: 0.1 }); document.querySelectorAll('.item-card').forEach(card => observer.observe(card)); }
            function renderPage(pageId) {
                const page = appData.categories.find(cat => cat.id === pageId); if (!page) { contentContainer.innerHTML = '<p>Page not found.</p>'; return; }
                document.querySelectorAll('.nav-item').forEach(link => link.classList.toggle('active', link.dataset.id === pageId));
                if (page.type === 'home') {
                    contentContainer.innerHTML = `<div class="page active" style="padding:0;"><div class="home-hero" style="background-image: url(${page.items[0].images[0]})"><h1>Welcome Aboard</h1><p>${page.items[0].description}</p></div><div style="padding:20px;"><div class="voyage-grid"><div class="grid-item"><div id="home-dest-label" class="label">Next Destination</div><div class="value" id="destination-home">--</div><div class="sub-value" id="eta-home">--</div></div><div class="grid-item"><div class="label">Current Speed</div><div class="value" id="speed-knots-home">--</div><div class="sub-value" id="speed-kmh-home">-- km/h</div></div></div></div></div>`;
                    updateShipData(true);
                } else if (page.type === 'voyage') {
                    contentContainer.innerHTML = `<div class="page active voyage-page"><div id="map"></div><div class="voyage-content"><div class="voyage-grid"><div class="grid-item"><div class="label">Current Speed</div><div class="value" id="speed-knots">--</div><div class="sub-value" id="speed-kmh">-- km/h</div></div><div class="grid-item"><div class="label">Onboard Time</div><div class="value" id="onboard-time">--:--</div><div class="sub-value">Tórshavn Timezone</div></div><div class="grid-item"><div class="label">Distance to Go</div><div class="value" id="distance">--</div><div class="sub-value" id="distance-unit">Kilometers</div></div><div class="grid-item"><div class="label" id="destination-label">Next Destination & ETA</div><div class="value" id="destination-voyage">--</div><div class="sub-value" id="eta-voyage">--</div></div></div><div class="weather-panel"><img id="weather-icon" src="" alt=""><div class="weather-info"><div class="label">Weather at Destination</div><div class="value"><span id="weather-temp">--°C</span>, <span id="weather-description">--</span></div></div></div></div></div>`;
                    initializeVoyagePage();
                } else {
                    contentContainer.innerHTML = `<div class="page active" style="padding:20px;"><div class="section-header"><h2>${page.title}</h2></div><div class="content-grid">${page.items.map(item => `<div class="item-card">${createImageArea(item.images)}<div class="item-info"><h3>${item.name}</h3>${item.description ? `<p>${item.description}</p>` : ''}<div class="fields">${(item.fields || []).map(field => `<div class="field"><strong>${field.label}:</strong><span>${field.value}</span></div>`).join('')}</div>${createMenu(item.menu)}${item.link && item.link.url ? `<a href="${item.link.url}" target="_blank" class="item-link-button">${item.link.text}</a>` : ''}</div></div>`).join('')}</div></div>`;
                    initializeSlideshows();
                }
                animateVisibleItems();
                window.location.hash = pageId;
            }
            async function init() {
                try {
                    const response = await fetch("data.json?v=" + Date.now()); if (!response.ok) throw new Error("Could not load data."); appData = await response.json();
                    document.getElementById("header-logo").src = appData.settings.logoUrl;
                    const navHtml = appData.categories.map(cat => `<a href="#${cat.id}" class="nav-item" data-id="${cat.id}"><span class="material-icons">${cat.icon}</span>${cat.title}</a>`).join(''); document.getElementById("bottom-nav").innerHTML = navHtml;
                    document.querySelectorAll('.nav-item').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); renderPage(e.currentTarget.dataset.id); }); });
                    const initialPageId = window.location.hash.substring(1) || appData.categories[0]?.id;
                    if (initialPageId) renderPage(initialPageId); else contentContainer.innerHTML = '<p>Welcome!</p>';
                } catch (error) { console.error(error); contentContainer.innerHTML = `<p>${error.message}</p>`; }
            }
            function updateHeaderTime() { document.getElementById('onboard-time-header').textContent = new Date().toLocaleTimeString('en-GB', { timeZone: 'Atlantic/Faroe', hour: '2-digit', minute: '2-digit' }); }
            const sailingRoute = ['hirtshals', 'torshavn', 'seydisfjord', 'torshavn'];
            const destinationMap = { torshavn: { name: "Tórshavn", country: "Faroe Islands", lat: 62.01, lon: -6.771 }, hirtshals: { name: "Hirtshals", country: "Denmark", lat: 57.594, lon: 9.965 }, seydisfjord: { name: "Seyðisfjörður", country: "Iceland", lat: 65.262, lon: -14.012 } };
            const conditionMap = { 'CLEAR': '01d', 'CLEAR_DAY': '01d', 'CLEAR_NIGHT': '01n', 'CLOUDY': '04d', 'CLOUDY_DAY': '04d', 'CLOUDY_NIGHT': '04n', 'PARTLY_CLOUDY': '03d', 'PARTLY_CLOUDY_DAY': '03d', 'PARTLY_CLOUDY_NIGHT': '03n', 'MOSTLY_CLOUDY': '04d', 'FOG': '50d', 'HAZE': '50d', 'MIST': '50d', 'RAIN': '10d', 'HEAVY_RAIN': '10d', 'SHOWERS': '09d', 'RAIN_SHOWERS': '09d', 'THUNDERSTORM': '11d', 'SNOW': '13d', 'SNOW_SHOWERS': '13d', 'SLEET': '13d', 'SUNNY': '01d', 'MOSTLY_SUNNY': '02d', 'PARTLY_SUNNY': '03d', 'UNKNOWN': '50d' };
            function normalizeDestinationName(e) { return e ? e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ð/g, "d").replace(/[^a-z0-9]/g, "") : "" }
            function haversineDistance(e,t,o,a){const n=6371,r=(o-e)*Math.PI/180,i=(a-t)*Math.PI/180,s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 2*n*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))}
            function formatETA(e) { if (!e) return { day: "--", time: "--:--" }; try { const t = new Date(e); if (isNaN(t.getTime())) return { day: "Invalid Date", time: "" }; const o = t.toLocaleDateString("en-GB", { weekday: "long", timeZone: "Atlantic/Faroe" }), a = t.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", hour12: !1, timeZone: "Atlantic/Faroe" }); return { day: o, time: a } } catch (e) { return { day: "Error", time: "" } } }
            async function fetchWeatherData(lat, lon) {
                try {
                    const apiKey = 'AIzaSyAAXsfnLWGjbcz4RGlERJwo3Y0Soe56ryI';
                    const url = `https://weather.googleapis.com/v1/currentConditions:lookup?key=${apiKey}&location.latitude=${lat}&location.longitude=${lon}`;
                    console.log("Fetching weather data from:", url);
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Weather API fetch failed: ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json();
                    console.log("Weather API response:", JSON.stringify(data, null, 2));
                    const tempEl = document.getElementById("weather-temp");
                    if (tempEl) {
                        tempEl.textContent = data.temperature?.degrees != null 
                            ? `${Math.round(data.temperature.degrees)}°C` 
                            : '--°C';
                    } else {
                        console.warn("Element #weather-temp not found");
                    }
                    const descEl = document.getElementById("weather-description");
                    if (descEl) {
                        descEl.textContent = data.weatherCondition?.description?.text || data.weatherCondition?.description || "N/A";
                    } else {
                        console.warn("Element #weather-description not found");
                    }
                    const weatherIconEl = document.getElementById("weather-icon");
                    if (weatherIconEl) {
                        const conditionType = data.weatherCondition?.type?.toUpperCase() || data.weatherCondition?.condition?.toUpperCase() || 'UNKNOWN';
                        const iconCode = conditionMap[conditionType] || '50d';
                        weatherIconEl.src = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
                    } else {
                        console.warn("Element #weather-icon not found");
                    }
                } catch (error) {
                    console.error("Weather fetch failed:", error.message);
                    const weatherDescEl = document.getElementById("weather-description");
                    if (weatherDescEl) weatherDescEl.textContent = 'Unavailable';
                    const weatherTempEl = document.getElementById("weather-temp");
                    if (weatherTempEl) weatherTempEl.textContent = '--°C';
                    const weatherIconEl = document.getElementById("weather-icon");
                    if (weatherIconEl) weatherIconEl.src = '';
                }
            }
            async function updateShipData(isHomePage = false) {
                try {
                    const response = await fetch("https://smyrillinewebapi-cec3fkhjh8bbhtd3.northeurope-01.azurewebsites.net/vessel/vessels");
                    const norrona = (await response.json()).find(v => v.vesselName?.toUpperCase() === 'NORRONA');
                    if (!norrona || !norrona.destinationFromAIS) return;
                    const speedKnots = norrona.position?.speed || 0;
                    const currentDestKey = normalizeDestinationName(norrona.destinationFromAIS.split(",")[0].trim());
                    const currentDestInfo = destinationMap[currentDestKey];
                    if (!currentDestInfo) return;
                    const hasArrived = new Date(norrona.etaFromAIS).getTime() < Date.now();
                    const { day, time } = formatETA(norrona.etaFromAIS);
                    if (isHomePage) {
                        const homeDestLabel = document.getElementById('home-dest-label');
                        const homeDest = document.getElementById('destination-home');
                        const homeEta = document.getElementById('eta-home');
                        document.getElementById('speed-knots-home').textContent = `${speedKnots} kn`;
                        document.getElementById('speed-kmh-home').textContent = `${(speedKnots * 1.852).toFixed(1)} km/h`;
                        if (hasArrived) {
                            homeDestLabel.textContent = "Current Port";
                            homeDest.textContent = currentDestInfo.name;
                            const lastIndex = sailingRoute.lastIndexOf(currentDestKey);
                            const nextPortKey = sailingRoute[lastIndex + 1] || sailingRoute[0];
                            homeEta.textContent = `Next Sailing: ${destinationMap[nextPortKey].name}`;
                        } else {
                            homeDestLabel.textContent = "Next Destination";
                            homeDest.textContent = currentDestInfo.name;
                            homeEta.textContent = `Arrival: ${day}, ${time}`;
                        }
                    } else {
                        const page = document.querySelector('.voyage-page'); if(!page) return;
                        document.getElementById("speed-knots").textContent = `${speedKnots} kn`;
                        document.getElementById("speed-kmh").textContent = `${(speedKnots * 1.852).toFixed(1)} km/h`;
                        const distance = haversineDistance(norrona.position.latitude, norrona.position.longitude, currentDestInfo.lat, currentDestInfo.lon);
                        if (distance < 1 && speedKnots < 1) {
                            document.getElementById("distance").textContent = "In Harbour";
                            document.getElementById("distance-unit").textContent = "At Destination";
                        } else {
                            document.getElementById("distance").textContent = `${Math.round(distance)}`;
                            document.getElementById("distance-unit").textContent = "Kilometers";
                        }
                        document.getElementById("destination-label").textContent = hasArrived ? "Arrival Information" : "Next Destination & ETA";
                        document.getElementById("destination-voyage").textContent = `${currentDestInfo.name}, ${currentDestInfo.country}`;
                        document.getElementById("eta-voyage").textContent = hasArrived ? `Arrived ${day} at ${time}` : `Arriving ${day} at ${time}`;
                        const onboardTimeEl = document.getElementById('onboard-time');
                        if (onboardTimeEl) onboardTimeEl.textContent = new Date().toLocaleTimeString("en-GB", { timeZone: "Atlantic/Faroe", hour: "2-digit", minute: "2-digit" });
                        if (map) {
                            const shipPos = [norrona.position.latitude, norrona.position.longitude];
                            const destPos = [currentDestInfo.lat, currentDestInfo.lon];
                            if (!map.shipMarker) { map.shipMarker = L.marker(shipPos, { icon: destIcon }).addTo(map); } else { map.shipMarker.setLatLng(shipPos); }
                            if (!map.destMarker) { map.destMarker = L.marker(destPos, { icon: destIcon }).addTo(map); } else { map.destMarker.setLatLng(destPos); }
                            map.fitBounds(L.latLngBounds(shipPos, destPos), { padding: [50, 50] });
                        }
                        setTimeout(() => fetchWeatherData(currentDestInfo.lat, currentDestInfo.lon), 0);
                    }
                } catch (e) { console.error("Failed to update ship data", e); }
            }
            function initializeVoyagePage() {
                if (map) { map.remove(); map = null; }
                map = L.map("map", { zoomControl: !1, attributionControl: !1, renderer: L.canvas() });
                L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { attribution: "", subdomains: "abcd" }).addTo(map);
                // Add dotted route line
                const routeCoordinates = [
                    [57.594, 9.965], // Hirtshals
                    [59.5, 2.0],    // Waypoint to avoid Norway
                    [62.01, -6.771], // Tórshavn
                    [65.262, -14.012], // Seyðisfjörður
                    [62.01, -6.771]  // Tórshavn
                ];
                L.polyline(routeCoordinates, {
                    color: '#00A9E0',
                    weight: 2,
                    dashArray: '5, 10',
                    opacity: 0.7
                }).addTo(map);
                updateShipData();
            }
            setInterval(updateShipData, 120000);
            setInterval(updateHeaderTime, 1000);
            init();
        });
    </script>
</body>
</html>
