<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Norr√∂na Onboard Guide</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>:root{--smyril-blue:#002B5C;--smyril-accent:#00A9E0;--background-dark:#001f44;--background-light:#f4f7f9;--surface-white:#ffffff;--text-dark:#212529;--text-light:#ffffff;--text-muted:#6c757d;--shadow:0 8px 30px rgba(0,43,92,.1);--border-radius:16px}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Poppins',sans-serif;background-color:var(--background-dark);color:var(--text-dark);line-height:1.7}body.mobile-nav-active{overflow:hidden}#app-shell{max-width:500px;margin:1rem auto;background-color:var(--background-light);border-radius:var(--border-radius);box-shadow:0 10px 40px rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);overflow:hidden;min-height:calc(100vh - 2rem)}@media (max-width:520px){#app-shell{margin:0;border-radius:0;border:none;min-height:100vh}}.main-header{position:sticky;top:0;z-index:1000;background-color:rgba(0,43,92,.85);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}.container{max-width:1200px;margin:0 auto;padding:0 20px}.navbar{display:flex;justify-content:space-between;align-items:center;height:70px}.navbar .logo img{height:28px}.nav-links{display:flex;list-style:none;gap:20px;overflow-x:auto;padding-bottom:5px}.nav-links a{color:var(--text-light);text-decoration:none;font-weight:600;padding:10px 5px;position:relative;transition:color .3s ease;white-space:nowrap}.nav-links a.active{color:var(--smyril-accent)}.hamburger-menu{display:none;background:none;border:none;cursor:pointer;padding:10px}.hamburger-menu .material-icons{color:var(--text-light);font-size:36px}.mobile-nav{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,43,92,.98);z-index:1100;display:flex;flex-direction:column;justify-content:center;align-items:center;transform:translateY(-100%);transition:transform .4s ease-in-out}.mobile-nav.active{transform:translateY(0)}.mobile-nav .close-btn{position:absolute;top:20px;right:20px;background:none;border:none;cursor:pointer}.mobile-nav .close-btn .material-icons{color:var(--text-light);font-size:40px}.mobile-nav ul{list-style:none;text-align:center}.mobile-nav ul li{margin:20px 0}.mobile-nav ul a{color:var(--text-light);text-decoration:none;font-size:2rem;font-weight:600;padding:10px}.mobile-nav ul a.active{color:var(--smyril-accent)}main{padding:30px}.section-header{margin-bottom:20px;text-align:center}.section-header h2{font-size:2.2rem;color:var(--smyril-blue);font-weight:700}.content-grid{display:grid;gap:20px}.item-card{background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden}.item-card .image-container{width:100%;height:220px;background:#eee}.item-card .item-card-image{width:100%;height:100%;object-fit:cover;display:block}.item-info{padding:25px}.item-info h3{font-size:1.5rem;color:var(--smyril-blue)}.item-info p{color:var(--text-muted);margin:10px 0}.item-info .fields{border-top:1px solid #eee;margin-top:15px;padding-top:15px;display:grid;gap:8px;font-size:.9rem}.item-info .field{display:flex;justify-content:space-between}.item-info .field strong{color:var(--text-dark)}.item-link-button{display:block;background-color:var(--smyril-blue);color:var(--text-light);text-align:center;padding:12px;border-radius:8px;text-decoration:none;font-weight:600;margin-top:20px;transition:background-color .3s ease}.item-link-button:hover{background-color:var(--smyril-accent)}.menu{border-top:1px solid #eee;margin-top:15px;padding-top:15px}.menu h4{font-weight:700;color:var(--smyril-blue);margin-bottom:10px}.menu-item{margin-bottom:10px}.menu-item-header{display:flex;justify-content:space-between;font-weight:600}.menu-item-desc{font-size:.9rem;color:var(--text-muted)}.slideshow{position:relative;width:100%;height:100%;overflow:hidden}.slide{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;transition:opacity .5s ease-in-out}.slide.active{opacity:1}.slide img{width:100%;height:100%;object-fit:cover}.slideshow-nav{position:absolute;top:50%;width:100%;display:flex;justify-content:space-between;transform:translateY(-50%)}.slideshow-nav button{background-color:rgba(0,43,92,.5);color:#fff;border:none;cursor:pointer;padding:10px;margin:0 10px;border-radius:50%}.slideshow-dots{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:5px}.slideshow-dots .dot{width:8px;height:8px;border-radius:50%;background-color:rgba(255,255,255,.5);transition:background-color .3s}.slideshow-dots .dot.active{background-color:#fff}.voyage-page{padding:0!important;background-color:var(--smyril-blue)}#map{width:100%;height:40vh;border-bottom:4px solid var(--smyril-accent)}.leaflet-container{background-color:#1a1a1a}.voyage-content{padding:30px 20px}.voyage-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}.grid-item{background-color:rgba(255,255,255,.05);border-radius:var(--border-radius);padding:20px;text-align:center;color:var(--text-light)}.grid-item .label{font-size:.9rem;font-weight:600;color:var(--smyril-accent);margin-bottom:10px;text-transform:uppercase}.grid-item .value{font-size:1.8rem;font-weight:700}.grid-item .sub-value{font-size:1rem;color:var(--text-muted)}.weather-panel{background-color:rgba(255,255,255,.05);border-radius:var(--border-radius);padding:20px;display:flex;align-items:center;gap:20px;color:var(--text-light)}.weather-panel img{width:80px;height:80px}.weather-info .label{font-size:.9rem;font-weight:600;color:var(--smyril-accent);text-transform:uppercase}.weather-info .value{font-size:1.5rem;font-weight:700}.weather-info #destination{font-size:1.2rem;display:block}@media (max-width:768px){.nav-links{display:none}.hamburger-menu{display:block}}</style>
</head>
<body>
    <div id="app-shell">
        <header class="main-header">
            <nav class="container navbar">
                <a href="#" class="logo"><img id="header-logo" src="" alt="Logo"></a>
                <div class="nav-links" id="nav-links"></div>
                <button class="hamburger-menu" id="hamburger-menu"><span class="material-icons">menu</span></button>
            </nav>
        </header>
        <div class="mobile-nav" id="mobile-nav">
            <button class="close-btn" id="close-btn"><span class="material-icons">close</span></button>
            <ul id="mobile-nav-links"></ul>
        </div>
        <main id="content-container"><p class="text-center text-muted p-10">Loading...</p></main>
    </div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const contentContainer = document.getElementById("content-container");
            let appData = {};
            let map; // map variable
            
            function createImageArea(images) { if (!Array.isArray(images) || images.length === 0) return `<div class="image-container" style="display:flex; align-items:center; justify-content:center; color:#ccc;">No Image</div>`; if (images.length === 1) return `<div class="image-container"><img src="${images[0]}" class="item-card-image" loading="lazy"></div>`; const slides = images.map((img, i) => `<div class="slide ${i === 0 ? 'active' : ''}" data-index="${i}"><img src="${img}"></div>`).join(''); const dots = images.map((_, i) => `<div class="dot ${i === 0 ? 'active' : ''}" data-index="${i}"></div>`).join(''); return `<div class="image-container"><div class="slideshow" data-total="${images.length}">${slides}<div class="slideshow-nav"><button class="prev"><span class="material-icons">arrow_back_ios</span></button><button class="next"><span class="material-icons">arrow_forward_ios</span></button></div><div class="slideshow-dots">${dots}</div></div></div>`; }
            function createMenu(menuItems) { if (!Array.isArray(menuItems) || menuItems.length === 0) return ''; return `<div class="menu"><h4>Menu</h4>${menuItems.map(item => `<div class="menu-item"><div class="menu-item-header"><span>${item.name}</span><span>${item.price}</span></div>${item.description ? `<div class="menu-item-desc">${item.description}</div>` : ''}</div>`).join('')}</div>`; }
            function initializeSlideshows() { document.querySelectorAll('.slideshow').forEach(slideshow => { let currentIndex = 0; const slides = slideshow.querySelectorAll('.slide'); const dots = slideshow.querySelectorAll('.dot'); const total = parseInt(slideshow.dataset.total, 10); function showSlide(index) { slides.forEach(s => s.classList.remove('active')); dots.forEach(d => d.classList.remove('active')); slides[index].classList.add('active'); dots[index].classList.add('active'); currentIndex = index; } slideshow.querySelector('.next').addEventListener('click', () => { showSlide((currentIndex + 1) % total); }); slideshow.querySelector('.prev').addEventListener('click', () => { showSlide((currentIndex - 1 + total) % total); }); }); }

            function renderPage(categoryId) {
                const category = appData.categories.find(cat => cat.id === categoryId); if (!category) { contentContainer.innerHTML = '<p>Content not found.</p>'; return; }
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                document.querySelectorAll(`.nav-link[data-id="${categoryId}"]`).forEach(link => link.classList.add('active'));

                if (category.type === 'voyage') {
                    contentContainer.innerHTML = `<div class="voyage-page"><div id="map"></div><div class="voyage-content"><div class="voyage-grid"><div class="grid-item"><div class="label">Current Speed</div><div class="value" id="speed-knots">--</div><div class="sub-value" id="speed-kmh">-- km/h</div></div><div class="grid-item"><div class="label">Onboard Time</div><div class="value" id="current-time">--:--</div><div class="sub-value">Atlantic/Faroe</div></div><div class="grid-item"><div class="label">Distance to Go</div><div class="value" id="distance">--</div><div class="sub-value">Kilometers</div></div><div class="grid-item"><div class="label">Arrival (ETA)</div><div class="value" id="eta-time">--:--</div><div class="sub-value" id="eta-day">--</div></div></div><div class="weather-panel"><img id="weather-icon" src="" alt=""><div class="weather-info"><div class="label">Weather at Destination</div><div class="value"><span id="weather-temp">--¬∞C</span>, <span id="weather-description">--</span></div><span id="destination">Loading...</span></div></div></div></div>`;
                    initializeVoyagePage();
                } else {
                    contentContainer.innerHTML = `<div class="section-header"><h2>${category.title}</h2></div><div class="content-grid">${category.items.map(item => `<div class="item-card">${createImageArea(item.images)}<div class="item-info"><h3>${item.name}</h3>${item.description ? `<p>${item.description}</p>` : ''}<div class="fields">${(item.fields || []).map(field => `<div class="field"><strong>${field.label}:</strong><span>${field.value}</span></div>`).join('')}</div>${createMenu(item.menu)}${item.link && item.link.url ? `<a href="${item.link.url}" target="_blank" class="item-link-button">${item.link.text}</a>` : ''}</div></div>`).join('')}</div>`;
                    initializeSlideshows();
                }
                window.location.hash = categoryId;
            }

            async function init() {
                try {
                    const response = await fetch("data.json?v=" + Date.now()); if (!response.ok) throw new Error("Could not load data."); appData = await response.json();
                    document.getElementById("header-logo").src = appData.settings.logoUrl;
                    const navHtml = appData.categories.map(cat => `<a href="#${cat.id}" class="nav-link" data-id="${cat.id}">${cat.title}</a>`).join(''); document.getElementById("nav-links").innerHTML = navHtml;
                    const mobileNavHtml = appData.categories.map(cat => `<li><a href="#${cat.id}" class="nav-link" data-id="${cat.id}">${cat.title}</a></li>`).join(''); document.getElementById("mobile-nav-links").innerHTML = mobileNavHtml;
                    document.querySelectorAll('.nav-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); renderPage(e.target.dataset.id); closeMobileMenu(); }); });
                    const initialCategoryId = window.location.hash.substring(1) || appData.categories[0]?.id;
                    if (initialCategoryId) renderPage(initialCategoryId); else contentContainer.innerHTML = '<p>Welcome!</p>';
                } catch (error) { console.error(error); contentContainer.innerHTML = `<p>${error.message}</p>`; }
            }
            const mobileNav = document.getElementById("mobile-nav"); function openMobileMenu() { mobileNav.classList.add("active"); document.body.classList.add("mobile-nav-active"); } function closeMobileMenu() { mobileNav.classList.remove("active"); document.body.classList.remove("mobile-nav-active"); }
            document.getElementById("hamburger-menu").addEventListener("click", openMobileMenu); document.getElementById("close-btn").addEventListener("click", closeMobileMenu);
            init();

            // --- VOYAGE PAGE LOGIC ---
            function initializeVoyagePage() {
                if (map) map.remove(); // Remove previous map instance if it exists
                map = L.map("map", { zoomControl: !1, attributionControl: !1, renderer: L.canvas() });
                L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { attribution: "", subdomains: "abcd" }).addTo(map);
                
                const shipIcon = L.divIcon({ html: '<svg width="32" height="18" viewBox="0 0 32 18" xmlns="http://www.w3.org/2000/svg"><path d="M2 13 Q6 15 28 15 L30 13 L30 10 L28 8 Q24 7 6 7 L2 9 Z" fill="#00A9E0" stroke="#FFFFFF" stroke-width="1"/><rect x="20" y="2" width="8" height="7" fill="#FFFFFF" stroke="#002B5C" stroke-width="1"/></svg>', className: "", iconSize: [32, 18], iconAnchor: [16, 9] });
                const destIcon = L.icon({ iconUrl: "https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png", iconSize: [12, 20], iconAnchor: [6, 20] });
                let shipMarker = null, destMarker = null;
                const destinationMap = { torshavn: { country: "Faroe Islands", lat: 62.01, lon: -6.771 }, hirtshals: { country: "Denmark", lat: 57.594, lon: 9.965 }, seydisfjord: { country: "Iceland", lat: 65.262, lon: -14.012 } };
                const conditionMap = { 'CLEAR': '01d', 'CLEAR_DAY': '01d', 'CLEAR_NIGHT': '01n', 'CLOUDY': '04d', 'CLOUDY_DAY': '04d', 'CLOUDY_NIGHT': '04n', 'PARTLY_CLOUDY': '03d', 'PARTLY_CLOUDY_DAY': '03d', 'PARTLY_CLOUDY_NIGHT': '03n', 'MOSTLY_CLOUDY': '04d', 'FOG': '50d', 'HAZE': '50d', 'MIST': '50d', 'RAIN': '10d', 'HEAVY_RAIN': '10d', 'SHOWERS': '09d', 'RAIN_SHOWERS': '09d', 'THUNDERSTORM': '11d', 'SNOW': '13d', 'SNOW_SHOWERS': '13d', 'SLEET': '13d', 'SUNNY': '01d', 'MOSTLY_SUNNY': '02d', 'PARTLY_SUNNY': '03d', 'UNKNOWN': '50d' };
                
                function haversineDistance(e, t, o, a) { const n = 6371, r = (o - e) * Math.PI / 180, i = (a - t) * Math.PI / 180, s = Math.sin(r / 2) * Math.sin(r / 2) + Math.cos(e * Math.PI / 180) * Math.cos(o * Math.PI / 180) * Math.sin(i / 2) * Math.sin(i / 2); return 2 * n * Math.atan2(Math.sqrt(s), Math.sqrt(1 - s)) }
                function formatETA(e) { if (!e) return { day: "--", time: "--:--" }; try { const t = new Date(e); if (isNaN(t.getTime())) return { day: "Invalid Date", time: "" }; const o = t.toLocaleDateString("en-GB", { weekday: "long", timeZone: "Atlantic/Faroe" }), a = t.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", hour12: !1, timeZone: "Atlantic/Faroe" }); return { day: o, time: a } } catch (e) { return { day: "Error", time: "" } } }
                function normalizeDestinationName(e) { return e ? e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/√∞/g, "d").replace(/[^a-z0-9]/g, "") : "" }
                
                async function fetchWeatherData(lat, lon) {
                    try {
                        const apiKey = 'AIzaSyAAXsfnLWGjbcz4RGlERJwo3Y0Soe56ryI';
                        const url = `https://weather.googleapis.com/v1/currentConditions:lookup?key=${apiKey}&location.latitude=${lat}&location.longitude=${lon}`;
                        const response = await fetch(url); if (!response.ok) throw new Error('Weather API fetch failed');
                        const data = await response.json();
                        document.getElementById("weather-temp").textContent = `${Math.round(data.temperature.degrees)}¬∞C`;
                        document.getElementById("weather-description").textContent = data.weatherCondition.description?.text || "Clear";
                        const conditionType = data.weatherCondition.type?.toUpperCase() || 'UNKNOWN';
                        const iconCode = conditionMap[conditionType] || '50d';
                        document.getElementById("weather-icon").src = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
                    } catch (error) { console.error("Weather fetch failed", error); document.getElementById("weather-description").textContent = 'N/A'; }
                }

                async function updateShipData() { try { const e = await fetch("https://smyrillinewebapi-cec3fkhjh8bbhtd3.northeurope-01.azurewebsites.net/vessel/vessels"), t = await e.json(), o = t.find(e => "NORRONA" === e.vesselName?.toUpperCase()); if (!o) return; const a = o.position?.speed || 0; document.getElementById("speed-knots").textContent = `${a} kn`, document.getElementById("speed-kmh").textContent = `${(1.852 * a).toFixed(1)} km/h`; const n = o.destinationFromAIS.split(",")[0].trim(), r = normalizeDestinationName(n), i = destinationMap[r]; if (i) { document.getElementById("destination").textContent = `${n}, ${i.country}`; const { day: e, time: t } = formatETA(o.etaFromAIS); document.getElementById("eta-day").textContent = e, document.getElementById("eta-time").textContent = t; const a = haversineDistance(o.position.latitude, o.position.longitude, i.lat, i.lon); document.getElementById("distance").textContent = `${Math.round(a)}`; const r = [o.position.latitude, o.position.longitude], s = [i.lat, i.lon]; shipMarker ? shipMarker.setLatLng(r) : shipMarker = L.marker(r, { icon: shipIcon }).addTo(map), destMarker ? destMarker.setLatLng(s) : destMarker = L.marker(s, { icon: destIcon }).addTo(map), map.fitBounds(L.latLngBounds(r, s), { padding: [50, 50] }), fetchWeatherData(i.lat, i.lon) } } catch (e) { console.error("Failed to update ship data", e) } }
                function updateTime() { const e = (new Date).toLocaleTimeString("en-GB", { timeZone: "Atlantic/Faroe", hour: "2-digit", minute: "2-digit", hour12: !1 }); document.getElementById("current-time").textContent = e }
                
                updateShipData();
                updateTime();
                setInterval(updateShipData, 120000);
                setInterval(updateTime, 1000);
            }
        });
    </script>
</body>
</html>
