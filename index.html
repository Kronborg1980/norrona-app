<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Norröna Onboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        :root {
            --primary-dark: #002836;  
            --primary-brand: #004A59; 
            --accent-gold: #FCB900;   
            --accent-gold-hover: #e5a800;
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.65);
            --glass-bg: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255,255,255,0.12);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            --card-radius: 20px;
            --nav-height: 75px;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:'Outfit',sans-serif; background:var(--primary-dark); color:var(--text-main);
               background-image:radial-gradient(circle at 50% -20%, var(--primary-brand) 0%, var(--primary-dark) 70%);
               background-attachment:fixed; min-height:100vh; -webkit-font-smoothing:antialiased; }
        #app-shell { max-width:480px; margin:0 auto; min-height:100vh; display:flex; flex-direction:column;
                     padding-bottom:calc(var(--nav-height)+30px); position:relative; overflow-x:hidden; }

        /* ==== NEW HEADER WITH DEPARTURE INFO ==== */
        .main-header { position:sticky; top:0; z-index:100; background:rgba(0,40,54,0.85);
                       backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
                       border-bottom:1px solid var(--glass-border); padding-top:env(safe-area-inset-top); }
        .navbar { display:flex; justify-content:space-between; align-items:center; height:64px; padding:0 20px; }
        .navbar .logo img { height:32px; width:auto; object-fit:contain; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .onboard-time { font-weight:600; font-size:0.85rem; letter-spacing:0.5px; background:var(--glass-bg);
                        padding:6px 10px; border-radius:50px; border:1px solid var(--glass-border); }

        .voyage-status { display:flex; align-items:center; gap:8px; background:rgba(0,0,0,0.3);
                         border:1px solid rgba(252,185,0,0.2); padding:6px 12px; border-radius:50px;
                         font-size:0.75rem; font-weight:700; color:var(--accent-gold); text-transform:uppercase;
                         letter-spacing:1px; box-shadow:0 2px 10px rgba(0,0,0,0.2); max-width:210px; }
        .status-dot { width:6px; height:6px; background:var(--accent-gold); border-radius:50%;
                      box-shadow:0 0 8px var(--accent-gold); animation:pulse 2s infinite; }
        @keyframes pulse { 0%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.9)} 100%{opacity:1;transform:scale(1)} }

        /* responsive – stack on very small screens */
        @media (max-width:379px) {
            .voyage-status { flex-direction:column; gap:2px; padding:6px 10px; text-align:center; max-width:none; }
            .voyage-status > div { margin-left:0 !important; }
        }

        /* Rest of your beautiful styles (unchanged) */
        .page { padding:24px; display:none; animation:fadeIn 0.5s cubic-bezier(0.16,1,0.3,1); }
        .page.active { display:block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(15px)} to{opacity:1;transform:translateY(0)} }

        .home-hero { height:65vh; display:flex; flex-direction:column; justify-content:flex-end; padding:32px;
                     position:relative; border-radius:0 0 40px 40px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.6); }
        .home-hero-bg { position:absolute; inset:0; z-index:1; background-size:cover; background-position:center;
                        animation:slowZoom 24s infinite alternate ease-in-out; }
        .home-hero::after { content:''; position:absolute; inset:0; z-index:2;
                            background:linear-gradient(to top,var(--primary-dark)10%,rgba(0,40,54,0.8)35%,rgba(0,40,54,0)70%); }
        .home-hero-content { position:relative; z-index:3; text-align:center; margin-bottom:20px; }
        .home-hero h1 { font-size:3rem; line-height:1.1; font-weight:700; margin-bottom:16px;
                         text-shadow:0 10px 30px rgba(0,0,0,0.8); letter-spacing:-1px; }
        @keyframes slowZoom { from{transform:scale(1)} to{transform:scale(1.15)} }

        .voyage-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:24px 0; }
        .grid-item { background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:16px;
                     padding:20px; text-align:center; display:flex; flex-direction:column;
                     justify-content:center; align-items:center; }
        .grid-item .label { font-size:0.7rem; color:var(--accent-gold); text-transform:uppercase;
                            letter-spacing:1.5px; margin-bottom:8px; font-weight:700; }
        .grid-item .value { font-size:1.4rem; font-weight:600; color:#fff; letter-spacing:-0.5px; }
        .grid-item .sub-value { font-size:0.85rem; color:var(--text-muted); margin-top:4px; font-weight:300; }

        #map { width:100%; height:50vh; border-radius:0 0 40px 40px; margin-bottom:20px;
               box-shadow:inset 0 -30px 60px var(--primary-dark); filter:saturate(0.8) contrast(1.1); }

        .bottom-nav { position:fixed; bottom:24px; left:24px; right:24px; max-width:432px; margin:0 auto;
                      height:var(--nav-height); background:rgba(0,40,54,0.9); backdrop-filter:blur(20px);
                      border:1px solid rgba(255,255,255,0.15); border-radius:24px; display:flex;
                      justify-content:space-evenly; align-items:center; z-index:1000;
                      box-shadow:0 20px 40px rgba(0,0,0,0.5); }
        .nav-item { display:flex; flex-direction:column; align-items:center; color:rgba(255,255,255,0.4);
                    text-decoration:none; font-size:0.7rem; font-weight:500; width:60px; height:100%; }
        .nav-item .material-icons { font-size:24px; margin-bottom:4px; }
        .nav-item.active { color:#fff; }
        .nav-item.active .material-icons { color:var(--accent-gold); transform:translateY(-4px);
                                         filter:drop-shadow(0 0 8px rgba(252,185,0,0.4)); }

        /* Modals etc. (unchanged) */
        #video-modal { display:none; position:fixed; inset:0; z-index:2000; background:rgba(0,0,0,0.95);
                       backdrop-filter:blur(10px); align-items:center; justify-content:center; padding:20px; }
        #video-modal.active { display:flex; }
    </style>
</head>
<body>
    <div id="app-shell">
        <header class="main-header">
            <nav class="navbar">
                <a href="#" class="logo"><img id="header-logo" src="" alt="Logo"></a>

                <!-- NEW SMART VOYAGE STATUS BAR -->
                <div class="voyage-status">
                    <span class="status-dot"></span>
                    <div style="display:flex; flex-direction:column; line-height:1.3; min-width:0;">
                        <div id="header-main-line" style="font-weight:700; font-size:0.75rem; letter-spacing:1px;">
                            Loading…
                        </div>
                        <div id="header-sub-line" style="font-size:0.65rem; opacity:0.8; margin-top:1px;">
                            Departure info…
                        </div>
                    </div>
                </div>

                <div class="onboard-time" id="onboard-time-header">--:--</div>
            </nav>
        </header>
        <main id="content-container"></main>
    </div>

    <nav class="bottom-nav" id="bottom-nav"></nav>

    <div id="video-modal">
        <div style="position:relative; width:100%; max-width:800px;">
            <span class="material-icons close-video" onclick="closeTrailer()">close</span>
            <div class="video-container"><div id="player-embed"></div></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const contentContainer = document.getElementById("content-container");
            let appData = {};
            let map = null;
            let liveRouteLine = null;

            // ICONS
            const pinIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41]
            });

            const createShipIcon = (course) => {
                const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FCB900" stroke="#002836" stroke-width="2"><path d="M12 2L19 21L12 17L5 21L12 2Z"/></svg>`;
                return L.divIcon({
                    className: 'ship-marker-container',
                    html: `<div style="transform:rotate(\( {course)deg);width:30px;height:30px;"> \){svg}</div>`,
                    iconSize: [30,30], iconAnchor: [15,15]
                });
            };

            // ==== YOUR EXISTING FUNCTIONS (createImageArea, createMenu, etc.) unchanged ====
            // … (keep all the functions you already have – they are perfect)

            function renderPage(pageId) {
                const page = appData.categories.find(cat => cat.id === pageId);
                if (!page) { contentContainer.innerHTML = '<p style="padding:20px">Page not found.</p>'; return; }
                document.querySelectorAll('.nav-item').forEach(link => link.classList.toggle('active', link.dataset.id === pageId));

                if (page.type === 'home') {
                    const heroItem = page.items[0] || { images:[], name:'', description:'' };
                    contentContainer.innerHTML = `
                        <div class="page active" style="padding:0;">
                            <div class="home-hero">
                                <div class="home-hero-bg" style="background-image:url(${heroItem.images[0]||''})"></div>
                                <div class="home-hero-content"><h1>\( {heroItem.name}</h1><p> \){heroItem.description}</p></div>
                            </div>
                            <div style="padding:24px;">
                                <div class="voyage-grid">
                                    <div class="grid-item"><div class="label">Next Stop</div>
                                        <div class="value" id="destination-home" style="font-size:1.6rem">--</div>
                                        <div class="sub-value" id="eta-home">--</div></div>
                                    <div class="grid-item"><div class="label">Speed & Course</div>
                                        <div class="value" style="font-size:1.2rem;"><span id="speed-knots-home">--</span> <span class="unit">|</span> <span id="speed-kmh-home">--</span></div>
                                        <div class="sub-value" id="course-home">Course: --°</div></div>
                                </div>
                            </div>
                        </div>`;
                    updateShipData(true);
                } else if (page.type === 'voyage') {
                    // unchanged – your map page
                    … (keep exactly as you had it)
                } else {
                    // normal page rendering – unchanged
                }
                window.location.hash = pageId;
            }

            async function init() {
                try {
                    const response = await fetch("data.json?v=" + Date.now());
                    if (!response.ok) throw new Error("Could not load data.");
                    appData = await response.json();
                    document.getElementById("header-logo").src = appData.settings.logoUrl;

                    const navHtml = appData.categories.map(cat => 
                        `<a href="#\( {cat.id}" class="nav-item" data-id=" \){cat.id}"><span class="material-icons">\( {cat.icon}</span> \){cat.title}</a>`
                    ).join('');
                    document.getElementById("bottom-nav").innerHTML = navHtml;

                    document.querySelectorAll('.nav-item').forEach(link => {
                        link.addEventListener('click', e => { e.preventDefault(); renderPage(e.currentTarget.dataset.id); });
                    });

                    const initialPageId = window.location.hash.substring(1) || appData.categories[0]?.id || 'home';
                    renderPage(initialPageId);
                } catch (err) {
                    console.error(err);
                    contentContainer.innerHTML = `<p>${err.message}</p>`;
                }
            }

            function updateHeaderTime() {
                const time = new Date().toLocaleTimeString('en-GB', { timeZone: 'Atlantic/Faroe', hour: '2-digit', minute: '2-digit' });
                document.getElementById('onboard-time-header').textContent = time;
            }

            const destinationMap = { 
                torshavn: { name: "Tórshavn", lat: 62.0080, lon: -6.7705 },
                hirtshals: { name: "Hirtshals", lat: 57.5915, lon: 9.9620 },
                seydisfjord: { name: "Seyðisfjörður", lat: 65.2595, lon: -14.0090 }
            };

            function normalizeDestinationName(str) {
                return str ? str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                              .replace(/ð/g, "d").replace(/[^a-z0-9]/g, "") : "";
            }

            function haversineDistance(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
                return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            }

            function formatETA(etaString) {
                if (!etaString) return { day: "--", time: "--:--" };
                const d = new Date(etaString);
                if (isNaN(d)) return { day: "--", time: "--:--" };
                return {
                    day: d.toLocaleDateString("en-GB", { weekday: "short", timeZone: "Atlantic/Faroe" }),
                    time: d.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", hour12: false, timeZone: "Atlantic/Faroe" })
                };
            }

            async function updateShipData(isHomePage = false) {
                try {
                    const response = await fetch("https://smyrillinewebapi-cec3fkhjh8bbhtd3.northeurope-01.azurewebsites.net/vessel/vessels");
                    const vessels = await response.json();
                    const norrona = vessels.find(v => v.vesselName?.toUpperCase() === 'NORRONA');
                    if (!norrona) return;

                    const speedKnots = norrona.position?.speed || 0;
                    const course = Math.round(norrona.position?.course || 0);
                    const currentDestKey = normalizeDestinationName(norrona.destinationFromAIS?.split(",")[0]);
                    const currentDestInfo = destinationMap[currentDestKey] || destinationMap['torshavn'];

                    const dist = haversineDistance(norrona.position.latitude, norrona.position.longitude, currentDestInfo.lat, currentDestInfo.lon);
                    const isInPort = speedKnots < 1 && dist < 2;

                    const { day, time } = formatETA(norrona.etaFromAIS);

                    // ===== NEW: EXTRACT DEPARTURE PORT & TIME =====
                    let departurePort = "—";
                    let departureTime = "--:--";
                    if (norrona.voyageInfo && norrona.voyageInfo.length > 0) {
                        const v = norrona.voyageInfo[0];
                        departurePort = v.departurePort || v.fromPort || currentDestInfo.name;
                        if (v.departureTime) {
                            const d = new Date(v.departureTime);
                            departureTime = d.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", timeZone: "Atlantic/Faroe" });
                        }
                    }

                    // ===== UPDATE NEW HEADER =====
                    if (isInPort) {
                        document.getElementById('header-main-line').textContent = `In Harbor – ${currentDestInfo.name}`;
                        document.getElementById('header-sub-line').textContent = "Enjoy your stay onboard";
                    } else {
                        document.getElementById('header-main-line').textContent = `To ${currentDestInfo.name}`;
                        document.getElementById('header-sub-line').innerHTML = `Dep. <span id="header-departure-from">\( {departurePort}</span> at <span id="header-departure-time"> \){departureTime}</span>`;
                    }

                    // Home page updates (your existing code)
                    if (isHomePage) {
                        if (isInPort) {
                            document.getElementById('destination-home').textContent = "In Harbor";
                            document.getElementById('eta-home').textContent = `Docked in ${currentDestInfo.name}`;
                        } else {
                            document.getElementById('destination-home').textContent = currentDestInfo.name;
                            document.getElementById('eta-home').textContent = `\( {day}, \){time}`;
                        }
                        document.getElementById('speed-knots-home').textContent = `${speedKnots} kn`;
                        document.getElementById('speed-kmh-home').textContent = `${(speedKnots * 1.852).toFixed(1)} km/h`;
                        document.getElementById('course-home').textContent = `Course: ${course}°`;
                    }

                    // Voyage page map updates – unchanged (your existing code)
                    // … (keep exactly as you wrote it)

                } catch (e) { console.log("Live data error:", e); }
            }

            // Clock & live updates
            setInterval(updateHeaderTime, 1000);
            setInterval(updateShipData, 60000);
            updateHeaderTime();
            updateShipData(); // initial load
            init();
        });
    </script>
</body>
</html>
