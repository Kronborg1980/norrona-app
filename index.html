<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"><title>Norröna Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700;800&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        :root {
            --brand-cyan: #00f3ff;
            --bg-deep: #020408;
            --glass-surface: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Manrope', sans-serif;
            background-color: var(--bg-deep);
            /* Aurora Background Effect */
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(0, 243, 255, 0.15), transparent 40%),
                radial-gradient(circle at 100% 50%, rgba(0, 102, 255, 0.1), transparent 50%);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 120px; /* Space for floating nav */
            overflow-x: hidden;
        }

        /* --- PREMIUM HEADER --- */
        .main-header {
            position: sticky; top: 0; z-index: 5000;
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 24px;
            background: rgba(2, 4, 8, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            height: 80px;
        }
        /* Running LED Line */
        .main-header::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 1px;
            background: linear-gradient(90deg, transparent, var(--brand-cyan), transparent);
            animation: shimmer 3s infinite linear;
        }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        .logo-img { height: 48px; width: auto; display: block; filter: drop-shadow(0 0 15px rgba(0,243,255,0.4)); }
        
        .onboard-time {
            font-weight: 700; font-size: 0.95rem; letter-spacing: 1px;
            color: var(--brand-cyan);
            background: rgba(0, 243, 255, 0.05);
            padding: 8px 16px; border-radius: 12px;
            border: 1px solid rgba(0, 243, 255, 0.15);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.05);
        }

        /* --- APP SHELL --- */
        #app-shell { max-width: 500px; margin: 0 auto; }
        .page { display: none; padding: 24px; opacity: 0; animation: fadeIn 0.4s ease forwards; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* --- HERO PORTAL (The Ship) --- */
        .hero-portal {
            position: relative; height: 55vh; width: 100%;
            border-radius: 160px 160px 30px 30px; /* The Arch Shape */
            overflow: hidden; margin-bottom: 30px;
            box-shadow: 0 20px 60px -10px rgba(0,0,0,0.8);
            border: 1px solid rgba(0, 243, 255, 0.3); /* Neon Border */
        }
        .hero-img {
            width: 100%; height: 100%; object-fit: cover;
            animation: slowPan 20s infinite alternate ease-in-out;
        }
        @keyframes slowPan { from { transform: scale(1.0); } to { transform: scale(1.1); } }
        
        .hero-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
            background: linear-gradient(to top, #020408 10%, transparent 100%);
            display: flex; flex-direction: column; justify-content: flex-end;
            padding: 30px;
        }
        .hero-title { font-size: 3rem; font-weight: 800; line-height: 0.9; margin-bottom: 8px; text-shadow: 0 10px 30px black; }
        .hero-sub { color: var(--brand-cyan); font-weight: 700; text-transform: uppercase; letter-spacing: 2px; font-size: 0.85rem; }

        /* --- GLASS WIDGETS --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        
        .glass-box {
            background: var(--glass-surface);
            border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        .label { font-size: 0.65rem; color: var(--brand-cyan); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; font-weight: 700; opacity: 0.8; }
        .value-lg { font-size: 1.8rem; font-weight: 800; color: white; line-height: 1; }
        .value-sub { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
        
        /* Speed Widget Specifics */
        .speed-wrap { display: flex; align-items: baseline; gap: 6px; }
        .unit { font-size: 0.9rem; color: var(--brand-cyan); font-weight: 600; }
        .course-wrap { display: flex; align-items: center; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); width: 100%; justify-content: center; }
        .nav-arrow { color: var(--brand-cyan); font-size: 18px; transition: transform 1s ease; filter: drop-shadow(0 0 5px var(--brand-cyan)); }

        /* --- MAP --- */
        #map { 
            width: 100%; height: 50vh; 
            border-radius: 24px; 
            border: 1px solid var(--glass-border);
            background: #050b14; 
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .leaflet-container { background: #050b14; font-family: 'Manrope', sans-serif; }

        /* --- LIST CARDS (Shops/Dining) --- */
        .content-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid var(--glass-border);
            border-radius: 20px; overflow: hidden; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card-img-box { height: 180px; position: relative; overflow: hidden; }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .card-badge {
            position: absolute; top: 15px; right: 15px;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            color: white; border: 1px solid rgba(255,255,255,0.2);
            padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
        }
        .card-body { padding: 20px; }
        .card-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 6px; }
        .card-text { font-size: 0.95rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 16px; }
        
        .info-row { display: flex; justify-content: space-between; font-size: 0.9rem; padding: 10px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-muted); }
        .info-val { font-weight: 600; color: white; }

        .btn-action {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            padding: 14px; border-radius: 12px; width: 100%;
            color: white; text-decoration: none; font-weight: 700; font-size: 0.95rem;
            margin-top: 12px; transition: 0.2s;
        }
        .btn-action:hover { background: rgba(255,255,255,0.1); border-color: var(--brand-cyan); }
        .btn-action.primary { background: var(--brand-cyan); color: #000; border: none; box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }

        /* --- FLOATING NAV --- */
        .floating-nav {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 420px; height: 70px;
            background: rgba(10, 15, 25, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 35px;
            display: flex; justify-content: space-around; align-items: center;
            padding: 0 5px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            z-index: 9000;
        }
        .nav-btn {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: rgba(255,255,255,0.4); text-decoration: none; height: 100%;
            transition: all 0.3s ease; position: relative;
        }
        .nav-icon { font-size: 26px; margin-bottom: 2px; transition: 0.3s; }
        .nav-text { font-size: 0.65rem; font-weight: 700; opacity: 0; transform: translateY(10px); transition: 0.3s; position: absolute; bottom: 8px; }
        
        .nav-btn.active { color: var(--brand-cyan); }
        .nav-btn.active .nav-icon { transform: translateY(-10px); filter: drop-shadow(0 0 8px var(--brand-cyan)); }
        .nav-btn.active .nav-text { opacity: 1; transform: translateY(0); }

        /* Markers */
        .ship-pulse-icon .ship-body { 
            width: 0; height: 0; 
            border-left: 12px solid transparent; border-right: 12px solid transparent; border-bottom: 30px solid var(--brand-cyan);
            filter: drop-shadow(0 0 10px var(--brand-cyan));
            transition: transform 1s ease; transform-origin: center bottom;
        }
        .ship-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 1px solid var(--brand-cyan); border-radius: 50%; opacity: 0; animation: ping 2.5s infinite; width: 80px; height: 80px; }
        @keyframes ping { 0% { transform: translate(-50%, -50%) scale(0.1); opacity: 0.8; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
    </style>
</head>
<body>
    <div id="app-shell">
        <header class="main-header">
            <div class="logo">
                <img class="logo-img" src="https://www.smyrilline.dk/wp-content/themes/lunnar-smyrilline/images/logo.svg" alt="Smyril Line">
            </div>
            <div class="onboard-time" id="onboard-time-header">--:--</div>
        </header>
        
        <main id="content-container"></main>
    </div>

    <nav class="floating-nav" id="bottom-nav"></nav>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const contentContainer = document.getElementById("content-container");
            let appData = {};
            let map;

            // --- Constants ---
            const waypoints = [[57.59, 9.97], [57.70, 9.50], [58.00, 8.00], [59.00, 4.00], [60.00, 1.00], [61.10, -0.60], [61.40, -3.00], [61.80, -5.50], [62.01, -6.77], [62.20, -7.00], [62.80, -8.50], [63.50, -10.00], [64.50, -12.00], [65.15, -13.50], [65.26, -14.00]];
            const docks = { 
                torshavn: { name: "Tórshavn", country: "Faroe Is.", lat: 62.0085, lon: -6.7665 }, 
                hirtshals: { name: "Hirtshals", country: "Denmark", lat: 57.5915, lon: 9.9725 }, 
                seydisfjord: { name: "Seyðisfjörður", country: "Iceland", lat: 65.2598, lon: -13.9975 } 
            };
            const shipIcon = L.divIcon({ className: 'ship-pulse-icon', html: '<div class="ship-body"></div><div class="ship-ring"></div>', iconSize: [60, 60], iconAnchor: [30, 45] });
            const destIcon = L.divIcon({ html: '<div style="width:12px;height:12px;background:#00f3ff;border-radius:50%;box-shadow:0 0 15px #00f3ff;border:2px solid white;"></div>', iconSize: [12, 12], iconAnchor: [6, 6] });

            // --- Helpers ---
            function normalize(s) { return s ? s.toLowerCase().replace(/[^a-z]/g, "") : ""; }
            function getDist(lat1, lon1, lat2, lon2) { 
                const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
                const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
                return Math.round(2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
            }
            function getDir(deg) { const d=['N','NE','E','SE','S','SW','W','NW']; return d[Math.round(deg/45)%8]; }
            function createImageArea(images) { return images && images.length ? `<div class="card-img-box"><img src="${images[0]}" class="card-img"></div>` : ''; }

            // --- Render Logic ---
            function renderPage(pageId) {
                const page = appData.categories.find(cat => cat.id === pageId);
                if (!page) return;

                // Update Nav Active State
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.id === pageId);
                });

                // Common Widgets
                const speedWidget = `
                    <div class="glass-box">
                        <div class="label">Speed & Course</div>
                        <div class="speed-wrap">
                            <span class="value-lg" id="spd-kn">--</span><span class="unit">kn</span>
                            <span style="color:#555">|</span>
                            <span class="value-sub" id="spd-km" style="color:white; opacity:0.7;">--</span>
                            <span class="unit">km/h</span>
                        </div>
                        <div class="course-wrap">
                            <span class="material-icons nav-arrow" id="nav-arrow">navigation</span>
                            <span class="value-sub" id="nav-dir" style="color:#fff; font-weight:700;">--°</span>
                        </div>
                    </div>`;

                let html = '';

                if (page.type === 'home') {
                    // HERO IMAGE - The Portal Design
                    const heroImg = "https://www.smyrilline.com/wp-content/uploads/2025/03/Norrona_Djupini_DSC6900-copy-2.jpg";
                    
                    html = `
                    <div class="page active">
                        <div class="hero-portal">
                           <img src="${heroImg}" class="hero-img">
                           <div class="hero-overlay">
                                <h1 class="hero-title">Norröna</h1>
                                <div class="hero-sub">Live Onboard Guide</div>
                           </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="glass-box">
                                <div class="label">Heading To</div>
                                <div class="value-lg" id="dest-home">--</div>
                                <div class="value-sub" id="eta-home" style="color:var(--brand-cyan)">--</div>
                            </div>
                            ${speedWidget}
                        </div>
                    </div>`;
                    updateData(); // Start data fetch

                } else if (page.type === 'voyage') {
                    html = `
                    <div class="page active">
                        <div style="padding: 0 10px 20px 10px;"><h2 style="font-size:2rem; font-weight:800;">Live Tracking</h2></div>
                        <div id="map"></div>
                        <div class="stats-grid">
                            ${speedWidget}
                            <div class="glass-box">
                                <div class="label">Distance Left</div>
                                <div class="value-lg" id="dist">--</div>
                                <div class="unit">Kilometers</div>
                            </div>
                            <div class="glass-box" style="grid-column:span 2; flex-direction:row; justify-content:space-between; text-align:left;">
                                <div>
                                    <div class="label">Destination</div>
                                    <div class="value-lg" id="dest-map" style="font-size:1.4rem">--</div>
                                    <div class="value-sub" id="eta-map">--</div>
                                </div>
                                <div style="text-align:right">
                                    <div class="label">Weather</div>
                                    <div class="value-lg" id="wx-temp">--°</div>
                                    <div class="value-sub" id="wx-desc">--</div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    
                    // Critical Map Fix: Wait for DOM, then init and resize
                    setTimeout(() => initMap(), 150);

                } else {
                    // Generic Grid Pages (Shops, Food, etc)
                    html = `<div class="page active">
                        <div style="padding: 0 10px 20px 10px;"><h2 style="font-size:2rem; font-weight:800;">${page.title}</h2></div>
                        <div class="grid-content">
                            ${page.items.map(item => `
                                <div class="content-card">
                                    ${item.images && item.images.length ? `<div class="card-img-box"><img src="${item.images[0]}" class="card-img">
                                    ${item.location ? `<div class="card-badge">${item.location}</div>` : ''}</div>` : ''}
                                    <div class="card-body">
                                        <div class="card-title">${item.name}</div>
                                        ${item.description ? `<p class="card-text">${item.description}</p>` : ''}
                                        
                                        ${item.openingHours ? item.openingHours.map(h=>`<div class="info-row"><span class="info-label">${h.day}</span><span class="info-val">${h.time}</span></div>`).join('') : ''}
                                        ${item.menu ? item.menu.map(m=>`<div class="info-row"><span class="info-val">${m.name}</span><span style="color:var(--brand-cyan)">${m.price}</span></div>`).join('') : ''}
                                        
                                        ${item.catalogs ? item.catalogs.map(c=>`<a href="${c.url}" target="_blank" class="btn-action"><span class="material-icons">menu_book</span> ${c.name}</a>`).join('') : ''}
                                        ${item.link && item.link.url ? `<a href="${item.link.url}" target="_blank" class="btn-action primary">${item.link.text || 'View Details'} <span class="material-icons" style="font-size:18px">arrow_forward</span></a>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }
                contentContainer.innerHTML = html;
            }

            // --- MAP FUNCTIONS ---
            function initMap() {
                if(map) { map.remove(); map = null; }
                const mapDiv = document.getElementById('map');
                if(!mapDiv) return;

                map = L.map("map", { zoomControl: false, attributionControl: false, renderer: L.canvas() });
                // Premium Dark Tiles
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 10 }).addTo(map);
                
                // Route
                L.polyline(waypoints, { color: '#00f3ff', weight: 3, opacity: 0.6, dashArray: '5, 10', className: 'flowing-dash' }).addTo(map);
                
                // IMPORTANT: Force resize to prevent grey box
                map.invalidateSize();
                updateData(); 
            }

            // --- DATA FETCH ---
            async function updateData() {
                try {
                    const res = await fetch("https://smyrillinewebapi-cec3fkhjh8bbhtd3.northeurope-01.azurewebsites.net/vessel/vessels");
                    const ship = (await res.json()).find(v => v.vesselName === 'NORRONA');
                    if(!ship) return;

                    const lat = ship.position.latitude, lon = ship.position.longitude, speed = ship.position.speed, course = ship.position.course;
                    const dk = normalize(ship.destinationFromAIS.split(',')[0]);
                    const dest = docks[dk] || docks.torshavn;
                    const etaDate = new Date(ship.etaFromAIS);
                    const etaStr = `${etaDate.toLocaleDateString('en-GB',{weekday:'short'})} ${etaDate.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}`;

                    const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
                    
                    setTxt('spd-kn', speed);
                    setTxt('spd-km', (speed*1.852).toFixed(0));
                    setTxt('nav-dir', `${course}° ${getDir(course)}`);
                    setTxt('destination-home', dest.name);
                    setTxt('eta-home', etaStr);
                    setTxt('dest-map', dest.name);
                    setTxt('eta-map', etaStr);
                    
                    const d = getDist(lat, lon, dest.lat, dest.lon);
                    setTxt('dist', d);

                    const arrow = document.getElementById('nav-arrow');
                    if(arrow) arrow.style.transform = `rotate(${course}deg)`;

                    if(map) {
                        const shipPos = [lat, lon];
                        if(!map.ship) map.ship = L.marker(shipPos, {icon: shipIcon, zIndexOffset:1000}).addTo(map);
                        else { map.ship.setLatLng(shipPos); map.ship.getElement().querySelector('.ship-body').style.transform = `rotate(${course}deg)`; }
                        
                        if(!map.dest) map.dest = L.marker([dest.lat, dest.lon], {icon: destIcon}).addTo(map);
                        else map.dest.setLatLng([dest.lat, dest.lon]);
                        
                        map.setView(shipPos, 6);
                        fetchWeather(dest.lat, dest.lon);
                    }

                } catch(e) { console.log("Data fetch error", e); }
            }

            async function fetchWeather(lat, lon) {
                try {
                    const r = await fetch(`https://weather.googleapis.com/v1/currentConditions:lookup?key=AIzaSyAAXsfnLWGjbcz4RGlERJwo3Y0Soe56ryI&location.latitude=${lat}&location.longitude=${lon}`);
                    const d = await r.json();
                    const elT = document.getElementById('wx-temp'), elD = document.getElementById('wx-desc');
                    if(elT && d.temperature) elT.innerText = Math.round(d.temperature.degrees) + "°";
                    if(elD && d.weatherCondition) elD.innerText = d.weatherCondition.description;
                } catch(e){}
            }

            // --- INIT ---
            async function init() {
                try {
                    const r = await fetch("data.json?v=" + Date.now());
                    appData = await r.json();
                    
                    const navEl = document.getElementById('bottom-nav');
                    navEl.innerHTML = appData.categories.map(c => 
                        `<a href="#${c.id}" class="nav-btn" data-id="${c.id}"><span class="material-icons nav-icon">${c.icon}</span><span class="nav-text">${c.title}</span></a>`
                    ).join('');
                    
                    document.querySelectorAll('.nav-btn').forEach(b => b.addEventListener('click', (e) => {
                        e.preventDefault(); renderPage(e.currentTarget.dataset.id);
                    }));

                    renderPage(window.location.hash.substring(1) || appData.categories[0].id);
                    
                    setInterval(() => {
                        const t = new Date().toLocaleTimeString('en-GB', {timeZone:'Atlantic/Faroe', hour:'2-digit', minute:'2-digit'});
                        document.getElementById('onboard-time-header').innerText = t;
                    }, 1000);
                    setInterval(updateData, 30000);

                } catch(e) { contentContainer.innerHTML = `<div style="text-align:center; margin-top:50px; color:#555;">Loading...<br>${e}</div>`; }
            }

            init();
        });
    </script>
</body>
</html>
