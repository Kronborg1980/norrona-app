<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Norröna Onboard - Voyage Info</title>
    
    <link href="https://unpkg.com/material-icons@1.13.12/iconfont/material-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    
    <style>
        :root {
            --primary-dark: #002836;  
            --primary-brand: #004A59; 
            --accent-gold: #FCB900;   
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.65);
            --glass-bg: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            --nav-height: 75px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--primary-dark); 
            color: var(--text-main); 
            background-image: radial-gradient(circle at 50% -20%, var(--primary-brand) 0%, var(--primary-dark) 70%); 
            background-attachment: fixed; 
            min-height: 100vh; 
            padding-bottom: env(safe-area-inset-bottom);
        }

        #app-shell { max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; padding-bottom: calc(var(--nav-height) + 30px); position: relative; overflow-x: hidden; }
        
        /* HEADER */
        .main-header { position: sticky; top: 0; z-index: 100; background: rgba(0, 40, 54, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); padding-top: env(safe-area-inset-top); }
        .navbar { display: flex; align-items: center; height: 60px; padding: 0 16px; gap: 10px; }
        .navbar .logo img { height: 28px; width: auto; }
        .onboard-time { font-weight: 600; font-size: 0.8rem; color: var(--text-main); background: var(--glass-bg); padding: 6px 10px; border-radius: 50px; border: 1px solid var(--glass-border); white-space: nowrap; }
        .voyage-status { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(252, 185, 0, 0.25); padding: 6px 10px; border-radius: 50px; height: 36px; min-width: 0; }
        .status-dot { width: 6px; height: 6px; background-color: var(--accent-gold); border-radius: 50%; box-shadow: 0 0 8px var(--accent-gold); animation: pulse 2s infinite; flex-shrink: 0; }
        #header-dest-text { font-size: 0.75rem; font-weight: 700; color: var(--accent-gold); text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* PAGES & MAP */
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .voyage-page.active { padding: 0; display: flex; flex-direction: column; }
        .voyage-map-container { position: relative; width: 100%; height: 35vh; padding: 12px 12px 0 12px; z-index: 1; }
        #map { width: 100%; height: 100%; background: #001e29; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.25); box-shadow: 0 4px 20px rgba(0,0,0,0.5); overflow: hidden; }
        .map-gradient { position: absolute; bottom: 0; left: 13px; right: 13px; height: 40px; background: linear-gradient(to bottom, transparent, rgba(0, 40, 54, 0.8)); border-radius: 0 0 20px 20px; pointer-events: none; z-index: 2; }
        
        .voyage-sheet { position: relative; z-index: 10; margin-top: -16px; background: var(--primary-dark); border-radius: 24px 24px 0 0; border-top: 1px solid var(--glass-border); padding: 24px 20px; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); min-height: 65vh; }

        /* WEATHER STRIP */
        .weather-strip { display: flex; align-items: center; justify-content: space-between; background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid var(--glass-border); border-radius: 16px; padding: 14px 16px; margin-bottom: 20px; }
        .weather-left { display: flex; align-items: center; gap: 12px; }
        .weather-left img { width: 40px; height: 40px; filter: drop-shadow(0 0 8px rgba(255,255,255,0.2)); }
        .weather-temp { font-size: 1.4rem; font-weight: 700; color: #fff; line-height: 1; }
        .weather-desc { font-size: 0.75rem; color: var(--accent-gold); text-transform: uppercase; font-weight: 600; margin-top: 4px; }
        .weather-label { font-size: 0.65rem; color: var(--text-muted); text-align: right; text-transform: uppercase; letter-spacing: 1px; }

        /* GRID SYSTEM */
        .voyage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-item { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 14px 10px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 95px; }
        .grid-item .label { font-size: 0.6rem; color: var(--accent-gold); opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; font-weight: 700; }
        .grid-item .value { font-size: 1.2rem; font-weight: 600; color: #fff; display: flex; align-items: baseline; justify-content: center; gap: 3px; }
        .grid-item .unit { font-size: 0.75rem; opacity: 0.6; font-weight: 400; }
        .grid-item .sub-value { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; font-weight: 300;}

        /* STANDARD UI ELEMENTS */
        .item-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; overflow: hidden; margin-bottom: 24px; }
        .image-container { width: 100%; height: 220px; background: #001e29; position: relative; }
        .item-card-image { width: 100%; height: 100%; object-fit: cover; }
        .item-info { padding: 20px; }
        .item-info h3 { color: white; margin-bottom: 8px; font-size: 1.4rem; }
        .item-info p { color: var(--text-muted); font-size: 0.95rem; line-height: 1.5; margin-bottom: 16px; }
        .item-link-button { display: flex; align-items: center; justify-content: center; gap: 8px; background-color: var(--accent-gold); color: #002836; padding: 16px; border-radius: 50px; text-decoration: none; font-weight: 700; margin-top: 10px; }

        /* NAVIGATION */
        .bottom-nav { position: fixed; bottom: 24px; left: 24px; right: 24px; max-width: 432px; margin: 0 auto; height: var(--nav-height); background: rgba(0, 40, 54, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.15); border-radius: 24px; display: flex; justify-content: space-evenly; align-items: center; z-index: 1000; box-shadow: 0 20px 40px rgba(0,0,0,0.5); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: rgba(255,255,255,0.4); text-decoration: none; font-size: 0.7rem; font-weight: 500; transition: all 0.3s; }
        .nav-item.active { color: #fff; }
        .nav-item .material-icons { font-size: 24px; margin-bottom: 4px; }
        .nav-item.active .material-icons { color: var(--accent-gold); transform: translateY(-3px); text-shadow: 0 0 10px rgba(252, 185, 0, 0.4); }

        .ship-marker-container { filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); transition: all 1s linear; }
    </style>
</head>
<body>
    <div id="app-shell">
        <header class="main-header">
            <nav class="navbar">
                <a href="#" class="logo"><img id="header-logo" src="" alt="Logo"></a>
                <div class="voyage-status">
                    <span class="status-dot"></span>
                    <span id="header-dest-text">LOADING...</span>
                </div>
                <div class="onboard-time" id="onboard-time-header">--:--</div>
            </nav>
        </header>
        <main id="content-container"></main>
    </div>
    <nav class="bottom-nav" id="bottom-nav"></nav>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const contentContainer = document.getElementById("content-container");
            let appData = {};
            let map;
            let liveRouteLine = null;
            
            // Hjælpefunktion til kompasretning (International)
            function getWindDirection(degrees) {
                const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
                return directions[Math.round(degrees / 45) % 8];
            }

            // Ikoner til kortet
            const pinIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            const createShipIcon = (course) => {
                const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FCB900" stroke="#002836" stroke-width="2" stroke-linejoin="round"><path d="M12 2L19 21L12 17L5 21L12 2Z"/></svg>`;
                return L.divIcon({ className: 'ship-marker-container', html: `<div style="transform: rotate(${course}deg); width: 30px; height: 30px;">${svg}</div>`, iconSize: [30, 30], iconAnchor: [15, 15] });
            };

            function renderPage(pageId) {
                const page = appData.categories.find(cat => cat.id === pageId);
                if (!page) return;
                
                document.querySelectorAll('.nav-item').forEach(link => link.classList.toggle('active', link.dataset.id === pageId));
                
                if (page.type === 'home') {
                    const hero = page.items[0];
                    contentContainer.innerHTML = `<div class="page active" style="padding:24px; padding-top:100px; text-align:center;"><h2>${hero.name}</h2><p>${hero.description}</p></div>`;
                } 
                else if (page.type === 'voyage') {
                    // --- VOYAGE SIDE ---
                    contentContainer.innerHTML = `
                        <div class="page active voyage-page" style="padding:0">
                            <div class="voyage-map-container">
                                <div id="map"></div>
                                <div class="map-gradient"></div>
                            </div>
                            <div class="voyage-sheet">
                                <div class="weather-strip">
                                    <div class="weather-left">
                                        <img id="weather-icon" src="" alt="">
                                        <div class="weather-details">
                                            <div class="weather-temp" id="weather-temp">--°C</div>
                                            <div class="weather-desc" id="weather-description">--</div>
                                        </div>
                                    </div>
                                    <div class="weather-label">Destination<br>Weather</div>
                                </div>

                                <div class="voyage-grid">
                                    
                                    <div class="grid-item">
                                        <div class="label">Speed</div>
                                        <div class="value"><span id="speed-knots">--</span> <span class="unit">kn</span></div>
                                        <div class="sub-value" id="speed-kmh">-- km/h</div>
                                    </div>

                                    <div class="grid-item">
                                        <div class="label">Course</div>
                                        <div class="value" id="course-voyage">--°</div>
                                        <div class="sub-value">Heading</div>
                                    </div>

                                    <div class="grid-item">
                                        <div class="label">Wind (Here)</div>
                                        <div class="value"><span id="wind-ms">--</span> <span class="unit">m/s</span></div>
                                        <div class="sub-value"><span id="wind-knots">--</span> kn <span id="wind-dir-text" style="margin-left:4px; font-weight:700; color:#fff;"></span></div>
                                    </div>

                                    <div class="grid-item">
                                        <div class="label">Wave Height (Here)</div>
                                        <div class="value"><span id="wave-height">--</span> <span class="unit">m</span></div>
                                        <div class="sub-value">Significant</div>
                                    </div>

                                    <div class="grid-item">
                                        <div class="label">Distance Left</div>
                                        <div class="value" id="distance">--</div>
                                        <div class="sub-value" id="distance-unit">Km</div>
                                    </div>

                                    <div class="grid-item">
                                        <div class="label">Time (Tórshavn)</div>
                                        <div class="value" id="onboard-time">--:--</div>
                                        <div class="sub-value">GMT</div>
                                    </div>

                                </div>
                                
                                <div style="margin-top: 20px; text-align:center;">
                                    <div class="label" style="font-size:0.65rem; color:var(--accent-gold); letter-spacing:1px; margin-bottom:4px; text-transform:uppercase; font-weight:700;">Next Destination</div>
                                    <div id="destination-voyage" style="font-size:1.3rem; font-weight:600; color:white;">--</div>
                                    <div id="eta-voyage" style="color:var(--text-muted); font-size:0.9rem; margin-top:4px;">--</div>
                                </div>
                            </div>
                        </div>`;
                    initializeVoyagePage();
                } else {
                    contentContainer.innerHTML = `<div class="page active" style="padding:24px; padding-top:20px;"><h2>${page.title}</h2>${page.items.map(item => `<div class="item-card"><div class="image-container"><img src="${item.images[0]}" class="item-card-image"></div><div class="item-info"><h3>${item.name}</h3><p>${item.description}</p>${item.link ? `<a href="${item.link.url}" class="item-link-button">${item.link.text}</a>` : ''}</div></div>`).join('')}</div>`;
                }
            }

            // --- FIXED: Use 'wave_height' (supported in current) instead of 'significant_wave_height' ---
            async function fetchMarineData(lat, lon) {
                try {
                    // CORRECT URL: using 'wave_height' in current as per Grok/Open-Meteo documentation
                    const url = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&current=wave_height,wind_wave_direction,wind_speed_10m,wind_direction_10m&hourly=wave_height&wind_speed_unit=ms&timeformat=unixtime`;
                    
                    const response = await fetch(url);
                    if (!response.ok) return; 
                    const data = await response.json();
                    
                    // --- BØLGER ---
                    // Now trying 'wave_height' which should exist
                    let waveHeight = data.current?.wave_height;
                    
                    // Fallback to hourly if current is strangely missing
                    if ((waveHeight === null || waveHeight === undefined) && data.hourly?.wave_height) {
                        const now = Math.floor(Date.now() / 1000);
                        let closestIndex = 0;
                        let minDiff = Infinity;
                        for (let i = 0; i < data.hourly.time.length; i++) {
                            const diff = Math.abs(data.hourly.time[i] - now);
                            if (diff < minDiff) { minDiff = diff; closestIndex = i; }
                        }
                        waveHeight = data.hourly.wave_height[closestIndex];
                    }

                    const elWave = document.getElementById('wave-height');
                    if(elWave) {
                        if (waveHeight !== null && waveHeight !== undefined) elWave.innerText = Number(waveHeight).toFixed(1);
                        else elWave.innerText = "--"; 
                    }

                    // --- VIND (Marine Kilde) ---
                    let windMs = data.current?.wind_speed_10m;
                    let windDir = data.current?.wind_direction_10m;

                    const elWindMs = document.getElementById('wind-ms');
                    const elWindKnots = document.getElementById('wind-knots');
                    const elWindDir = document.getElementById('wind-dir-text');

                    if(elWindMs && windMs !== null && windMs !== undefined) {
                         elWindMs.innerText = Math.round(windMs);
                         if(elWindKnots) elWindKnots.innerText = Math.round(windMs * 1.94384);
                         if(elWindDir && windDir !== null) elWindDir.innerText = getWindDirection(windDir);
                    }

                } catch(e) { console.log("Marine data error", e); }
            }

            // Henter Vejr (Skyer/Temp) + Vind Backup
            async function fetchWeatherStandard(lat, lon) {
                try {
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weathercode,wind_speed_10m,wind_direction_10m&wind_speed_unit=ms&temperature_unit=celsius`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    // Ikon + Temp
                    const wCode = data.current.weathercode;
                    let desc = "Cloudy"; let icon = "03d";
                    if(wCode <= 1) { desc = "Clear"; icon = "01d"; }
                    else if(wCode <= 3) { desc = "Cloudy"; icon = "03d"; }
                    else if(wCode <= 48) { desc = "Fog"; icon = "50d"; }
                    else if(wCode <= 67) { desc = "Rain"; icon = "10d"; }
                    else if(wCode <= 77) { desc = "Snow"; icon = "13d"; }
                    else { desc = "Storm"; icon = "11d"; }

                    const elTemp = document.getElementById("weather-temp");
                    const elDesc = document.getElementById("weather-description");
                    const elIcon = document.getElementById("weather-icon");

                    if(elTemp) elTemp.innerText = Math.round(data.current.temperature_2m) + "°C";
                    if(elDesc) elDesc.innerText = desc;
                    if(elIcon) elIcon.src = `https://openweathermap.org/img/wn/${icon}@2x.png`;

                    // BACKUP VIND: Kun hvis Marine API stadig viser "--"
                    const elWindMs = document.getElementById('wind-ms');
                    if (elWindMs && elWindMs.innerText === "--" && data.current.wind_speed_10m !== null) {
                        const windMs = data.current.wind_speed_10m;
                        elWindMs.innerText = Math.round(windMs);
                        const elWindKnots = document.getElementById('wind-knots');
                        if(elWindKnots) elWindKnots.innerText = Math.round(windMs * 1.94384);
                        const elWindDir = document.getElementById('wind-dir-text');
                        if(elWindDir) elWindDir.innerText = getWindDirection(data.current.wind_direction_10m);
                    }

                } catch(e) { console.log("Standard weather error", e); }
            }

            async function updateShipData() {
                try {
                    const response = await fetch("https://smyrillinewebapi-cec3fkhjh8bbhtd3.northeurope-01.azurewebsites.net/vessel/vessels");
                    const norrona = (await response.json()).find(v => v.vesselName?.toUpperCase() === 'NORRONA');
                    if (!norrona) return;

                    const speedKnots = norrona.position?.speed || 0;
                    const course = Math.round(norrona.position?.course || 0);
                    const lat = norrona.position.latitude;
                    const lon = norrona.position.longitude;

                    // Header
                    const destName = norrona.destinationFromAIS.split(",")[0];
                    document.getElementById('header-dest-text').innerText = "To " + destName;
                    
                    if(document.querySelector('.voyage-page')) {
                        document.getElementById('speed-knots').innerText = speedKnots.toFixed(1);
                        document.getElementById('speed-kmh').innerText = (speedKnots * 1.852).toFixed(1) + " km/h";
                        document.getElementById('course-voyage').innerText = course + "°";
                        document.getElementById('onboard-time').innerText = new Date().toLocaleTimeString("en-GB", { timeZone: "Atlantic/Faroe", hour: "2-digit", minute: "2-digit" });
                        
                        // Distance (demo)
                        const destLat = 62.00; const destLon = -6.77; 
                        const dist = Math.sqrt(Math.pow(destLat - lat, 2) + Math.pow(destLon - lon, 2)) * 111; 
                        document.getElementById('distance').innerText = Math.round(dist);
                        document.getElementById('destination-voyage').innerText = destName;
                        
                        // Map
                        if(map) {
                            const shipPos = [lat, lon];
                            if (!map.shipMarker) map.shipMarker = L.marker(shipPos, { icon: createShipIcon(course) }).addTo(map);
                            else { map.shipMarker.setLatLng(shipPos); map.shipMarker.setIcon(createShipIcon(course)); }
                            if(!liveRouteLine) {
                                liveRouteLine = L.polyline([shipPos, [destLat, destLon]], {color: '#00f2ff', weight: 3, dashArray: '10, 10', opacity:0.8}).addTo(map);
                                map.setView(shipPos, 6);
                            }
                        }

                        // DATA FETCH
                        fetchMarineData(lat, lon);
                        fetchWeatherStandard(lat, lon);
                    }

                } catch(e) { console.log(e); }
            }

            function initializeVoyagePage() {
                if (map) { map.remove(); map = null; }
                map = L.map("map", { zoomControl: false, attributionControl: false }).setView([62.0, -6.0], 5);
                L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { subdomains: "abcd" }).addTo(map);
                updateShipData();
            }

            // Init
            async function init() {
                const res = await fetch("data.json");
                appData = await res.json();
                document.getElementById("header-logo").src = appData.settings.logoUrl;
                document.getElementById("bottom-nav").innerHTML = appData.categories.map(cat => `<a href="#" class="nav-item" data-id="${cat.id}"><span class="material-icons">${cat.icon}</span>${cat.title}</a>`).join('');
                document.querySelectorAll('.nav-item').forEach(l => l.addEventListener('click', (e) => { e.preventDefault(); renderPage(e.currentTarget.dataset.id); }));
                
                setInterval(updateShipData, 60000); 
                renderPage('voyage');
            }
            init();
        });
    </script>
</body>
</html>
