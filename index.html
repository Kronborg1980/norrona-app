<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"><title>Norröna Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700;800&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        :root {
            --neon-blue: #00f3ff;
            --deep-space: #050b14;
            --glass-bg: rgba(16, 24, 39, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-white: #ffffff;
            --text-gray: #94a3b8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Manrope', sans-serif;
            background-color: var(--deep-space);
            background-image: radial-gradient(circle at 50% 0%, #1a2c42 0%, var(--deep-space) 80%);
            color: var(--text-white);
            min-height: 100vh;
            padding-bottom: 100px; /* Space for bottom nav */
        }

        /* --- HEADER --- */
        .main-header {
            position: sticky; top: 0; z-index: 5000;
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px;
            background: rgba(5, 11, 20, 0.8);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .logo-img { height: 32px; width: auto; display: block; filter: drop-shadow(0 0 10px rgba(0, 243, 255, 0.3)); }
        .onboard-time {
            font-weight: 700; font-size: 0.9rem; letter-spacing: 0.5px;
            color: var(--neon-blue);
            background: rgba(0, 243, 255, 0.1);
            padding: 6px 12px; border-radius: 8px;
            border: 1px solid rgba(0, 243, 255, 0.2);
        }

        /* --- LAYOUT & ANIMATION --- */
        #app-shell { max-width: 500px; margin: 0 auto; }
        .page { display: none; padding: 20px; opacity: 0; transition: opacity 0.3s ease; }
        .page.active { display: block; opacity: 1; }

        /* --- HERO CARD (The Ship) --- */
        .hero-card {
            position: relative; height: 50vh; border-radius: 24px; overflow: hidden;
            margin-bottom: 24px;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.7);
            border: 1px solid var(--glass-border);
        }
        .hero-img {
            width: 100%; height: 100%; object-fit: cover;
            transform: scale(1.05); /* Subtle zoom */
        }
        .hero-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, #050b14 0%, transparent 100%);
            padding: 40px 20px 20px 20px;
        }
        .hero-title { font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: 5px; }
        .hero-sub { color: var(--neon-blue); font-weight: 600; text-transform: uppercase; letter-spacing: 2px; font-size: 0.8rem; }

        /* --- WIDGETS --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        
        .glass-box {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 16px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .label { font-size: 0.7rem; color: var(--text-gray); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; font-weight: 600; }
        .value-lg { font-size: 1.5rem; font-weight: 700; color: white; }
        .value-sm { font-size: 0.8rem; color: var(--text-gray); }
        
        /* Speed Widget Details */
        .speed-wrap { display: flex; align-items: baseline; gap: 4px; }
        .unit { font-size: 0.8rem; color: var(--neon-blue); }
        .course-wrap { display: flex; align-items: center; gap: 6px; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.1); width: 100%; justify-content: center; }
        .nav-arrow { color: var(--neon-blue); font-size: 16px; transition: transform 1s ease; }

        /* --- MAP --- */
        #map { 
            width: 100%; height: 50vh; 
            border-radius: 24px; 
            border: 1px solid var(--glass-border);
            background: #050b14; 
            z-index: 1;
            margin-bottom: 20px;
        }
        /* Fix for Leaflet grey box */
        .leaflet-container { background: #050b14; font-family: 'Manrope', sans-serif; }

        /* --- LIST ITEMS (Shops/Dining) --- */
        .content-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px; overflow: hidden; margin-bottom: 20px;
        }
        .card-img-box { height: 160px; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-badge {
            position: absolute; top: 12px; right: 12px;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            color: var(--neon-blue); border: 1px solid var(--neon-blue);
            padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
        }
        .card-body { padding: 16px; }
        .card-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 4px; }
        .card-text { font-size: 0.9rem; color: var(--text-gray); line-height: 1.5; margin-bottom: 12px; }
        
        .info-row { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 8px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-gray); }
        .info-val { font-weight: 600; color: white; }

        .btn-action {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            padding: 12px; border-radius: 10px; width: 100%;
            color: white; text-decoration: none; font-weight: 600; font-size: 0.9rem;
            margin-top: 10px; transition: 0.2s;
        }
        .btn-action.primary { background: var(--neon-blue); color: #000; border: none; }

        /* --- NAVIGATION --- */
        .floating-nav {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 450px; height: 65px;
            background: rgba(10, 20, 35, 0.95);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            z-index: 9000;
        }
        .nav-btn {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-gray); text-decoration: none; height: 100%;
            transition: all 0.3s ease;
        }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }
        .nav-text { font-size: 0.65rem; font-weight: 600; }
        .nav-btn.active { color: var(--neon-blue); transform: translateY(-2px); }
        .nav-btn.active .nav-icon { text-shadow: 0 0 10px rgba(0,243,255,0.6); }

        /* Ship Marker */
        .ship-pulse-icon .ship-body { 
            width: 0; height: 0; 
            border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 26px solid var(--neon-blue);
            filter: drop-shadow(0 0 8px var(--neon-blue));
            transition: transform 1s ease; transform-origin: center bottom;
        }
        .ship-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 1px solid var(--neon-blue); border-radius: 50%; opacity: 0; animation: ping 2.5s infinite; width: 60px; height: 60px; }
        @keyframes ping { 0% { transform: translate(-50%, -50%) scale(0.1); opacity: 0.8; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }
    </style>
</head>
<body>
    <div id="app-shell">
        <header class="main-header">
            <div class="logo">
                <img class="logo-img" src="https://www.smyrilline.dk/wp-content/themes/lunnar-smyrilline/images/logo.svg" alt="Smyril Line">
            </div>
            <div class="onboard-time" id="onboard-time-header">--:--</div>
        </header>
        
        <main id="content-container"></main>
    </div>

    <nav class="floating-nav" id="bottom-nav"></nav>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const contentContainer = document.getElementById("content-container");
            let appData = {};
            let map;

            // --- Constants ---
            const waypoints = [[57.59, 9.97], [57.70, 9.50], [58.00, 8.00], [59.00, 4.00], [60.00, 1.00], [61.10, -0.60], [61.40, -3.00], [61.80, -5.50], [62.01, -6.77], [62.20, -7.00], [62.80, -8.50], [63.50, -10.00], [64.50, -12.00], [65.15, -13.50], [65.26, -14.00]];
            const docks = { 
                torshavn: { name: "Tórshavn", country: "Faroe Is.", lat: 62.0085, lon: -6.7665 }, 
                hirtshals: { name: "Hirtshals", country: "Denmark", lat: 57.5915, lon: 9.9725 }, 
                seydisfjord: { name: "Seyðisfjörður", country: "Iceland", lat: 65.2598, lon: -13.9975 } 
            };
            const shipIcon = L.divIcon({ className: 'ship-pulse-icon', html: '<div class="ship-body"></div><div class="ship-ring"></div>', iconSize: [60, 60], iconAnchor: [30, 45] });
            const destIcon = L.divIcon({ html: '<div style="width:10px;height:10px;background:#00f3ff;border-radius:50%;box-shadow:0 0 10px #00f3ff;"></div>', iconSize: [10, 10], iconAnchor: [5, 5] });

            // --- Helpers ---
            function normalize(s) { return s ? s.toLowerCase().replace(/[^a-z]/g, "") : ""; }
            function getDist(lat1, lon1, lat2, lon2) { 
                const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
                const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
                return Math.round(2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
            }
            function getDir(deg) { const d=['N','NE','E','SE','S','SW','W','NW']; return d[Math.round(deg/45)%8]; }

            // --- Render Logic ---
            function renderPage(pageId) {
                const page = appData.categories.find(cat => cat.id === pageId);
                if (!page) return;

                // Update Nav Active State
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.id === pageId);
                });

                // Common Widgets
                const speedWidget = `
                    <div class="glass-box">
                        <div class="label">Speed & Course</div>
                        <div class="speed-wrap">
                            <span class="value-lg" id="spd-kn">--</span><span class="unit">kn</span>
                            <span style="color:#555">|</span>
                            <span class="value-sm" id="spd-km">-- km/h</span>
                        </div>
                        <div class="course-wrap">
                            <span class="material-icons nav-arrow" id="nav-arrow">navigation</span>
                            <span class="value-sm" id="nav-dir">--</span>
                        </div>
                    </div>`;

                let html = '';

                if (page.type === 'home') {
                    // HERO IMAGE - Fixed to use the specific ship image requested
                    const heroImg = "https://www.smyrilline.com/wp-content/uploads/2025/03/Norrona_Djupini_DSC6900-copy-2.jpg";
                    
                    html = `
                    <div class="page active">
                        <div class="hero-card">
                            <img src="${heroImg}" class="hero-img">
                            <div class="hero-overlay">
                                <h1 class="hero-title">Norröna</h1>
                                <div class="hero-sub">Live Onboard Guide</div>
                            </div>
                        </div>
                        <div class="stats-grid">
                            <div class="glass-box">
                                <div class="label">Heading To</div>
                                <div class="value-lg" id="dest-home">--</div>
                                <div class="value-sm" id="eta-home" style="color:var(--neon-blue)">--</div>
                            </div>
                            ${speedWidget}
                        </div>
                    </div>`;
                    updateData(); // Start data fetch

                } else if (page.type === 'voyage') {
                    html = `
                    <div class="page active">
                        <div style="padding-bottom:10px"><h2 style="font-size:1.5rem; font-weight:800;">Live Tracking</h2></div>
                        <div id="map"></div>
                        <div class="stats-grid">
                            ${speedWidget}
                            <div class="glass-box">
                                <div class="label">Distance Left</div>
                                <div class="value-lg" id="dist">--</div>
                                <div class="unit">Kilometers</div>
                            </div>
                            <div class="glass-box" style="grid-column:span 2; flex-direction:row; justify-content:space-between; text-align:left;">
                                <div>
                                    <div class="label">Destination</div>
                                    <div class="value-lg" id="dest-map" style="font-size:1.2rem">--</div>
                                    <div class="value-sm" id="eta-map">--</div>
                                </div>
                                <div style="text-align:right">
                                    <div class="label">Weather</div>
                                    <div class="value-lg" id="wx-temp">--°</div>
                                    <div class="value-sm" id="wx-desc">--</div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    
                    // Critical Map Fix: Wait for DOM, then init
                    setTimeout(() => initMap(), 100);

                } else {
                    // Generic Grid Pages (Shops, Food, etc)
                    html = `<div class="page active">
                        <div style="padding-bottom:20px"><h2 style="font-size:2rem; font-weight:800;">${page.title}</h2></div>
                        <div class="grid-content">
                            ${page.items.map(item => `
                                <div class="content-card">
                                    ${item.images && item.images.length ? `<div class="card-img-box"><img src="${item.images[0]}" class="card-img">
                                    ${item.location ? `<div class="card-badge">${item.location}</div>` : ''}</div>` : ''}
                                    <div class="card-body">
                                        <div class="card-title">${item.name}</div>
                                        ${item.description ? `<p class="card-text">${item.description}</p>` : ''}
                                        
                                        ${item.openingHours ? item.openingHours.map(h=>`<div class="info-row"><span class="info-label">${h.day}</span><span class="info-val">${h.time}</span></div>`).join('') : ''}
                                        ${item.menu ? item.menu.map(m=>`<div class="info-row"><span class="info-val">${m.name}</span><span style="color:var(--neon-blue)">${m.price}</span></div>`).join('') : ''}
                                        ${item.catalogs ? item.catalogs.map(c=>`<a href="${c.url}" target="_blank" class="btn-action"><span class="material-icons">menu_book</span> ${c.name}</a>`).join('') : ''}
                                        ${item.link && item.link.url ? `<a href="${item.link.url}" target="_blank" class="btn-action primary">${item.link.text || 'View Details'}</a>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }
                contentContainer.innerHTML = html;
            }

            // --- MAP FUNCTIONS ---
            function initMap() {
                if(map) { map.remove(); map = null; }
                const mapDiv = document.getElementById('map');
                if(!mapDiv) return;

                map = L.map("map", { zoomControl: false, attributionControl: false, renderer: L.canvas() });
                // Dark Matter Tiles
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 10 }).addTo(map);
                
                // Draw Route Line
                L.polyline(waypoints, { color: '#00f3ff', weight: 3, opacity: 0.6, dashArray: '5, 10', className: 'flowing-dash' }).addTo(map);
                
                // Force resize to prevent grey box
                setTimeout(() => map.invalidateSize(), 200);
                updateData(); // Fetch ship pos immediately
            }

            // --- DATA FETCH ---
            async function updateData() {
                try {
                    // Ship Data
                    const res = await fetch("https://smyrillinewebapi-cec3fkhjh8bbhtd3.northeurope-01.azurewebsites.net/vessel/vessels");
                    const ship = (await res.json()).find(v => v.vesselName === 'NORRONA');
                    if(!ship) return;

                    // Extract
                    const lat = ship.position.latitude, lon = ship.position.longitude, speed = ship.position.speed, course = ship.position.course;
                    const dk = normalize(ship.destinationFromAIS.split(',')[0]);
                    const dest = docks[dk] || docks.torshavn;
                    const etaDate = new Date(ship.etaFromAIS);
                    const etaStr = `${etaDate.toLocaleDateString('en-GB',{weekday:'short'})} ${etaDate.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}`;

                    // Update Text Elements (Safe check ids)
                    const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
                    
                    setTxt('spd-kn', speed);
                    setTxt('spd-km', (speed*1.852).toFixed(0));
                    setTxt('nav-dir', `${course}° ${getDir(course)}`);
                    setTxt('destination-home', dest.name);
                    setTxt('eta-home', etaStr);
                    setTxt('dest-map', dest.name);
                    setTxt('eta-map', etaStr);
                    
                    // Distance
                    const d = getDist(lat, lon, dest.lat, dest.lon);
                    setTxt('dist', d);

                    // Rotate Arrow
                    const arrow = document.getElementById('nav-arrow');
                    if(arrow) arrow.style.transform = `rotate(${course}deg)`;

                    // Map Update
                    if(map) {
                        const shipPos = [lat, lon];
                        if(!map.ship) map.ship = L.marker(shipPos, {icon: shipIcon, zIndexOffset:1000}).addTo(map);
                        else { map.ship.setLatLng(shipPos); map.ship.getElement().querySelector('.ship-body').style.transform = `rotate(${course}deg)`; }
                        
                        if(!map.dest) map.dest = L.marker([dest.lat, dest.lon], {icon: destIcon}).addTo(map);
                        else map.dest.setLatLng([dest.lat, dest.lon]);
                        
                        map.setView(shipPos, 6);
                        
                        // Weather (Lazy load)
                        fetchWeather(dest.lat, dest.lon);
                    }

                } catch(e) { console.log("Data fetch error", e); }
            }

            async function fetchWeather(lat, lon) {
                try {
                    const r = await fetch(`https://weather.googleapis.com/v1/currentConditions:lookup?key=AIzaSyAAXsfnLWGjbcz4RGlERJwo3Y0Soe56ryI&location.latitude=${lat}&location.longitude=${lon}`);
                    const d = await r.json();
                    const elT = document.getElementById('wx-temp'), elD = document.getElementById('wx-desc');
                    if(elT && d.temperature) elT.innerText = Math.round(d.temperature.degrees) + "°";
                    if(elD && d.weatherCondition) elD.innerText = d.weatherCondition.description;
                } catch(e){}
            }

            // --- INIT ---
            async function init() {
                try {
                    const r = await fetch("data.json?v=" + Date.now());
                    appData = await r.json();
                    
                    // Render Bottom Nav
                    const navEl = document.getElementById('bottom-nav');
                    navEl.innerHTML = appData.categories.map(c => 
                        `<a href="#${c.id}" class="nav-btn" data-id="${c.id}"><span class="material-icons nav-icon">${c.icon}</span><span class="nav-text">${c.title}</span></a>`
                    ).join('');
                    
                    document.querySelectorAll('.nav-btn').forEach(b => b.addEventListener('click', (e) => {
                        e.preventDefault(); renderPage(e.currentTarget.dataset.id);
                    }));

                    // Start
                    renderPage(window.location.hash.substring(1) || appData.categories[0].id);
                    
                    // Clock & Data Loop
                    setInterval(() => {
                        const t = new Date().toLocaleTimeString('en-GB', {timeZone:'Atlantic/Faroe', hour:'2-digit', minute:'2-digit'});
                        document.getElementById('onboard-time-header').innerText = t;
                    }, 1000);
                    setInterval(updateData, 30000);

                } catch(e) { contentContainer.innerHTML = `<div style="text-align:center; margin-top:50px;">Error loading content.<br>${e}</div>`; }
            }

            init();
        });
    </script>
</body>
</html>
