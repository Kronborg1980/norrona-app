<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Norröna Onboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        :root {
            --primary-dark: #002836;  
            --primary-brand: #004A59; 
            --accent-gold: #FCB900;   
            --accent-gold-hover: #e5a800;
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.65);
            --glass-bg: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            --card-radius: 20px;
            --nav-height: 75px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--primary-dark); color: var(--text-main); background-image: radial-gradient(circle at 50% -20%, var(--primary-brand) 0%, var(--primary-dark) 70%); background-attachment: fixed; min-height: 100vh; -webkit-font-smoothing: antialiased; }
        #app-shell { max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; padding-bottom: calc(var(--nav-height) + 30px); position: relative; overflow-x: hidden; }
        
        /* Header */
        .main-header { position: sticky; top: 0; z-index: 100; background: rgba(0, 40, 54, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); padding-top: env(safe-area-inset-top); transition: all 0.3s ease; }
        .navbar { display: flex; justify-content: space-between; align-items: center; height: 64px; padding: 0 20px; }
        .navbar .logo img { height: 32px; width: auto; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .onboard-time { font-weight: 600; font-size: 0.85rem; letter-spacing: 0.5px; color: var(--text-main); opacity: 0.9; background: var(--glass-bg); padding: 6px 10px; border-radius: 50px; border: 1px solid var(--glass-border); }
        .voyage-status { display: flex; align-items: center; gap: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(252, 185, 0, 0.2); padding: 6px 14px; border-radius: 50px; font-size: 0.7rem; font-weight: 700; color: var(--accent-gold); text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .status-dot { width: 6px; height: 6px; background-color: var(--accent-gold); border-radius: 50%; box-shadow: 0 0 8px var(--accent-gold); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        @media (max-width: 340px) { .voyage-status { display: none; } }

        /* Layout */
        .page { padding: 24px; display: none; animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .section-header { margin-bottom: 24px; margin-top: 10px; }
        .section-header h2 { font-size: 1.75rem; font-weight: 700; letter-spacing: -0.5px; color: white; }
        
        /* Cards */
        .item-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--card-radius); overflow: hidden; margin-bottom: 24px; box-shadow: var(--glass-shadow); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .item-card:active { transform: scale(0.99); }
        .image-container { width: 100%; height: 240px; background: #001e29; position: relative; }
        .item-card-image { width: 100%; height: 100%; object-fit: cover; }
        .item-info { padding: 24px; }
        .item-info h3 { font-size: 1.5rem; font-weight: 600; margin-bottom: 8px; color: #fff; letter-spacing: -0.3px; }
        .item-info p { color: var(--text-muted); font-size: 0.95rem; line-height: 1.6; margin-bottom: 20px; }
        .fields { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px; margin-top: 16px; border: 1px solid rgba(255,255,255,0.05); display: grid; gap: 14px; }
        .field { display: flex; justify-content: space-between; font-size: 0.9rem; align-items: center; }
        .field strong { color: var(--accent-gold); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
        .field span { color: #fff; font-weight: 500; }
        .offer-box { margin-top: 24px; padding: 20px; border: 1px solid rgba(252, 185, 0, 0.3); border-radius: 16px; background: linear-gradient(135deg, rgba(252, 185, 0, 0.1), transparent); position: relative; overflow: hidden; }
        .offer-box::before { content: '★'; position: absolute; top: -10px; right: -10px; font-size: 80px; color: var(--accent-gold); opacity: 0.1; transform: rotate(15deg); }
        .offer-box h4 { color: var(--accent-gold); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1.5px; font-weight: 700; margin-bottom: 10px; }
        .offer-item { font-weight: 600; font-size: 1.1rem; color: white; margin-bottom: 4px; }
        .offer-desc { font-size: 0.9rem; color: rgba(255,255,255,0.8); }
        .button-group { margin-top: 28px; display: grid; gap: 14px; }
        .item-link-button { display: flex; align-items: center; justify-content: center; gap: 8px; background-color: var(--accent-gold); color: #002836; text-align: center; padding: 16px; border-radius: 50px; text-decoration: none; font-weight: 700; font-size: 0.95rem; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(252, 185, 0, 0.2); }
        .item-link-button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(252, 185, 0, 0.3); background-color: var(--accent-gold-hover); }
        .item-link-button.secondary { background: transparent; border: 2px solid rgba(255,255,255,0.2); color: #fff; box-shadow: none; }
        .item-link-button.secondary:hover { border-color: #fff; background: rgba(255,255,255,0.05); }
        .item-link-button.trailer { background: #e11d48; color: white; box-shadow: 0 4px 12px rgba(225, 29, 72, 0.3); }
        
        /* Home Hero */
        .home-hero { height: 65vh; display: flex; flex-direction: column; justify-content: flex-end; padding: 32px; position: relative; border-radius: 0 0 40px 40px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        .home-hero-bg { position: absolute; inset: 0; z-index: 1; background-size: cover; background-position: center; animation: slowZoom 24s infinite alternate ease-in-out; }
        .home-hero::after { content: ''; position: absolute; inset: 0; z-index: 2; background: linear-gradient(to top, var(--primary-dark) 10%, rgba(0,40,54,0.8) 35%, rgba(0,40,54,0) 70%); }
        .home-hero-content { position: relative; z-index: 3; text-align: center; margin-bottom: 20px; }
        .home-hero h1 { font-size: 3rem; line-height: 1.1; font-weight: 700; margin-bottom: 16px; text-shadow: 0 10px 30px rgba(0,0,0,0.8); letter-spacing: -1px; }
        .home-hero p { font-size: 1.1rem; color: rgba(255,255,255,0.9); margin: 0 auto; max-width: 90%; text-shadow: 0 2px 4px rgba(0,0,0,0.8); line-height: 1.5; }
        @keyframes slowZoom { from { transform: scale(1); } to { transform: scale(1.15); } }
        
        /* UPDATED GRID ITEMS (CENTERED) */
        .voyage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 24px 0; }
        
        .grid-item { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            border-radius: 16px; 
            padding: 20px; 
            text-align: center;
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            align-items: center; 
        }
        .grid-item .label { 
            font-size: 0.7rem; color: var(--accent-gold); opacity: 0.9; 
            text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; font-weight: 700; 
        }
        .grid-item .value { 
            font-size: 1.4rem; font-weight: 600; color: #fff; letter-spacing: -0.5px; 
            display: flex; 
            align-items: baseline; 
            justify-content: center; 
            gap: 4px; 
        }
        .grid-item .unit { font-size: 0.8rem; opacity: 0.6; font-weight: 400; margin-left: 2px; }
        .grid-item .sub-value { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; font-weight: 300;}
        
        #map { width: 100%; height: 50vh; border-radius: 0 0 40px 40px; margin-bottom: 20px; box-shadow: inset 0 -30px 60px var(--primary-dark); filter: saturate(0.8) contrast(1.1); }
        
        /* Map Icon Styles */
        .ship-marker-container { transition: all 0.5s ease-out; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }

        /* UPDATED WEATHER PANEL (CENTERED) */
        .weather-panel { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            border-radius: 16px; 
            padding: 16px 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 20px; 
            margin-bottom: 12px; 
            margin-top: -10px;
            box-shadow: var(--glass-shadow);
            backdrop-filter: blur(12px);
        }
        .weather-panel img { width: 50px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.4)); }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 24px; left: 24px; right: 24px; max-width: 432px; margin: 0 auto; height: var(--nav-height); background: rgba(0, 40, 54, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.15); border-radius: 24px; display: flex; justify-content: space-evenly; align-items: center; z-index: 1000; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.4); text-decoration: none; font-size: 0.7rem; font-weight: 500; transition: all 0.3s ease; width: 60px; height: 100%; }
        .nav-item .material-icons { font-size: 24px; margin-bottom: 4px; transition: 0.3s; }
        .nav-item.active { color: #fff; }
        .nav-item.active .material-icons { color: var(--accent-gold); transform: translateY(-4px); filter: drop-shadow(0 0 8px rgba(252, 185, 0, 0.4)); }
        .nav-item.active::after { content: ''; width: 4px; height: 4px; background: var(--accent-gold); border-radius: 50%; position: absolute; bottom: 12px; }
        
        /* Modals */
        #video-modal { display: none; position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); align-items: center; justify-content: center; padding: 20px; }
        #video-modal.active { display: flex; animation: fadeIn 0.3s ease; }
        .video-container { width: 100%; max-width: 800px; aspect-ratio: 16/9; background: black; border-radius: 16px; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; border: 1px solid rgba(255,255,255,0.1); }
        .close-video { position: absolute; top: -50px; right: 0; color: white; font-size: 32px; cursor: pointer; opacity: 0.8; transition: 0.2s; }
        .close-video:hover { opacity: 1; transform: scale(1.1); }
        .slideshow { position: relative; width: 100%; height: 100%; }
        .slide { position: absolute; inset: 0; opacity: 0; transition: opacity 0.5s; }
        .slide.active { opacity: 1; }
        .slide img { width: 100%; height: 100%; object-fit: cover; }
        .slideshow-dots { position: absolute; bottom: 12px; left: 0; right: 0; display: flex; justify-content: center; gap: 8px; }
        .dot { width: 6px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 50%; }
        .dot.active { background: var(--accent-gold); box-shadow: 0 0 8px var(--accent-gold); }
    </style>
</head>
<body>
    <div id="app-shell">
        <header class="main-header">
            <nav class="navbar">
                <a href="#" class="logo"><img id="header-logo" src="" alt="Logo"></a>
                <div class="voyage-status">
                    <span class="status-dot"></span>
                    <span id="header-dest-text">MS NORRÖNA</span>
                </div>
                <div class="onboard-time" id="onboard-time-header">--:--</div>
            </nav>
        </header>
        <main id="content-container"></main>
    </div>
    <nav class="bottom-nav" id="bottom-nav"></nav>
    
    <div id="video-modal">
        <div style="position:relative; width:100%; max-width:800px;">
            <span class="material-icons close-video" onclick="closeTrailer()">close</span>
            <div class="video-container"><div id="player-embed"></div></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const contentContainer = document.getElementById("content-container");
            let appData = {};
            let map;
            let liveRouteLine = null;
            
            // ICONS DEFINITIONS
            const pinIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            const createShipIcon = (course) => {
                // Gold ship SVG arrow
                const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FCB900" stroke="#002836" stroke-width="2" stroke-linejoin="round"><path d="M12 2L19 21L12 17L5 21L12 2Z"/></svg>`;
                return L.divIcon({
                    className: 'ship-marker-container',
                    html: `<div style="transform: rotate(${course}deg); width: 30px; height: 30px;">${svg}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
            };

            function createImageArea(images) {
                if (!Array.isArray(images) || images.length === 0) return `<div class="image-container" style="display:none"></div>`;
                if (images.length === 1) return `<div class="image-container"><img src="${images[0]}" class="item-card-image" loading="lazy"></div>`;
                const slides = images.map((img, i) => `<div class="slide ${i === 0 ? 'active' : ''}"><img src="${img}"></div>`).join('');
                const dots = images.map((_, i) => `<div class="dot ${i === 0 ? 'active' : ''}"></div>`).join('');
                return `<div class="image-container"><div class="slideshow" data-total="${images.length}">${slides}<div class="slideshow-nav"><button class="prev">&lt;</button><button class="next">&gt;</button></div><div class="slideshow-dots">${dots}</div></div></div>`;
            }

            function createMenu(menuItems) {
                if (!Array.isArray(menuItems) || menuItems.length === 0) return '';
                return `
                <div style="margin-top:24px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                    <h4 style="color:var(--accent-gold); text-transform:uppercase; font-size:0.7rem; font-weight:700; letter-spacing:1px; margin-bottom:12px;">Details / Schedule</h4>
                    ${menuItems.map(item => `
                        <div style="display:flex; justify-content:space-between; margin-bottom:14px; align-items:center;">
                            <div style="flex:1; padding-right:10px;">
                                <div style="font-weight:600; font-size:0.95rem; color:#fff;">${item.name}</div>
                                ${item.description ? `<div style="font-size:0.8rem; color:rgba(255,255,255,0.5); margin-top:2px;">${item.description}</div>` : ''}
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="font-weight:600; color:#fff; font-size:0.95rem;">${item.price}</div>
                                ${item.trailerUrl ? `<button onclick="openTrailer('${item.trailerUrl}')" style="background:var(--accent-gold); border:none; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#002836;"><span class="material-icons" style="font-size:18px;">play_arrow</span></button>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>`;
            }

            function createOffers(offers) {
                if (!Array.isArray(offers) || offers.length === 0) return '';
                return `<div class="offer-box"><h4>Special Offers</h4>${offers.map(o => `<div><div class="offer-item">${o.title}</div><div class="offer-desc">${o.description}</div></div>`).join('<br>')}</div>`;
            }

            function initializeSlideshows() {
                document.querySelectorAll('.slideshow').forEach(slideshow => {
                    let currentIndex = 0;
                    const slides = slideshow.querySelectorAll('.slide'), dots = slideshow.querySelectorAll('.dot'), total = slides.length;
                    function showSlide(index) { slides.forEach(s => s.classList.remove('active')); dots.forEach(d => d.classList.remove('active')); slides[index].classList.add('active'); dots[index].classList.add('active'); currentIndex = index; }
                    slideshow.querySelector('.next').addEventListener('click', (e) => { e.preventDefault(); showSlide((currentIndex + 1) % total)});
                    slideshow.querySelector('.prev').addEventListener('click', (e) => { e.preventDefault(); showSlide((currentIndex - 1 + total) % total)});
                });
            }

            window.openTrailer = function(url) {
                if (!url) return;
                let embedUrl = "";
                const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^#&?]*).*/);
                if (ytMatch && ytMatch[1]) { embedUrl = `https://www.youtube.com/embed/${ytMatch[1]}?autoplay=1&modestbranding=1&rel=0`; } else { embedUrl = url; } 
                document.getElementById('player-embed').innerHTML = `<iframe src="${embedUrl}" width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="width:100%; height:100%"></iframe>`;
                document.getElementById('video-modal').classList.add('active');
            }
            window.closeTrailer = function() {
                document.getElementById('video-modal').classList.remove('active');
                document.getElementById('player-embed').innerHTML = '';
            }

            function renderPage(pageId) {
                const page = appData.categories.find(cat => cat.id === pageId);
                if (!page) { contentContainer.innerHTML = '<p style="padding:20px">Page not found.</p>'; return; }
                document.querySelectorAll('.nav-item').forEach(link => link.classList.toggle('active', link.dataset.id === pageId));
                
                if (page.type === 'home') {
                    const heroItem = page.items[0] || { images:[], name:'', description:'' };
                    contentContainer.innerHTML = `<div class="page active" style="padding:0;"><div class="home-hero"><div class="home-hero-bg" style="background-image: url(${heroItem.images[0] || ''})"></div><div class="home-hero-content"><h1>${heroItem.name}</h1><p>${heroItem.description}</p></div></div><div style="padding:24px;"><div class="voyage-grid"><div class="grid-item"><div id="home-dest-label" class="label">Next Stop</div><div class="value" id="destination-home" style="font-size:1.6rem">--</div><div class="sub-value" id="eta-home">--</div></div><div class="grid-item"><div class="label">Speed & Course</div><div class="value" style="font-size: 1.2rem;"><span id="speed-knots-home">--</span> <span class="unit">|</span> <span id="speed-kmh-home">--</span></div><div class="sub-value" id="course-home">Course: --°</div></div></div></div></div>`;
                    updateShipData(true);
                } else if (page.type === 'voyage') {
                    contentContainer.innerHTML = `
                        <div class="page active voyage-page" style="padding:0">
                            <div id="map"></div>
                            <div style="padding:0 24px 24px 24px;">
                                <div class="weather-panel">
                                    <img id="weather-icon" src="" alt="">
                                    <div class="weather-info">
                                        <div class="label" style="color:var(--accent-gold)">Weather at Destination</div>
                                        <div class="value" style="font-size:1.2rem"><span id="weather-temp">--°C</span>, <span id="weather-description">--</span></div>
                                    </div>
                                </div>
                                <div class="voyage-grid">
                                    <div class="grid-item">
                                        <div class="label">Speed & Course</div>
                                        <div class="value" style="font-size: 1.2rem;"><span id="speed-knots">--</span> <span class="unit">|</span> <span id="speed-kmh">--</span></div>
                                        <div class="sub-value" id="course-voyage">Course: --°</div>
                                    </div>
                                    <div class="grid-item">
                                        <div class="label">Time (Tórshavn)</div>
                                        <div class="value" id="onboard-time" style="font-size:1.6rem">--:--</div>
                                        <div class="sub-value">GMT</div>
                                    </div>
                                    <div class="grid-item">
                                        <div class="label">Distance Left</div>
                                        <div class="value" id="distance" style="font-size:1.6rem">--</div>
                                        <div class="sub-value" id="distance-unit">Kilometers</div>
                                    </div>
                                    <div class="grid-item">
                                        <div class="label" id="destination-label">Next Destination</div>
                                        <div class="value" id="destination-voyage" style="font-size:1.6rem">--</div>
                                        <div class="sub-value" id="eta-voyage">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    initializeVoyagePage();
                } else {
                    contentContainer.innerHTML = `<div class="page active"><div class="section-header"><h2>${page.title}</h2></div><div class="content-grid">${page.items.map(item => `<div class="item-card">${createImageArea(item.images)}<div class="item-info"><h3>${item.name}</h3>${item.description ? `<p>${item.description}</p>` : ''}${(item.fields || []).length > 0 ? `<div class="fields">${item.fields.map(f => `<div class="field"><strong>${f.label}</strong><span>${f.value}</span></div>`).join('')}</div>` : ''}${createOffers(item.offers)}${createMenu(item.menu)}<div class="button-group">${item.trailerUrl ? `<button onclick="openTrailer('${item.trailerUrl}')" class="item-link-button trailer"><span class="material-icons">play_circle_filled</span> Watch Main Trailer</button>` : ''}${item.link && item.link.url ? `<a href="${item.link.url}" target="_blank" class="item-link-button">${item.link.text}</a>` : ''}${item.secondaryLink && item.secondaryLink.url ? `<a href="${item.secondaryLink.url}" target="_blank" class="item-link-button secondary">${item.secondaryLink.text}</a>` : ''}</div></div></div>`).join('')}</div></div>`;
                    initializeSlideshows();
                }
                window.location.hash = pageId;
            }

            async function init() {
                try {
                    const response = await fetch("data.json?v=" + Date.now());
                    if (!response.ok) throw new Error("Could not load data.");
                    appData = await response.json();
                    document.getElementById("header-logo").src = appData.settings.logoUrl;
                    const navHtml = appData.categories.map(cat => `<a href="#${cat.id}" class="nav-item" data-id="${cat.id}"><span class="material-icons">${cat.icon}</span>${cat.title}</a>`).join('');
                    document.getElementById("bottom-nav").innerHTML = navHtml;
                    document.querySelectorAll('.nav-item').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); renderPage(e.currentTarget.dataset.id); }); });
                    const initialPageId = window.location.hash.substring(1) || appData.categories[0]?.id;
                    if (initialPageId) renderPage(initialPageId);
                } catch (error) { console.error(error); contentContainer.innerHTML = `<p>${error.message}</p>`; }
            }

            function updateHeaderTime() { document.getElementById('onboard-time-header').textContent = new Date().toLocaleTimeString('en-GB', { timeZone: 'Atlantic/Faroe', hour: '2-digit', minute: '2-digit' }); }
            
            // UPDATED DESTINATION COORDINATES
            const destinationMap = { 
                torshavn: { name: "Tórshavn", country: "FO", lat: 62.0080, lon: -6.7705 }, 
                hirtshals: { name: "Hirtshals", country: "DK", lat: 57.5915, lon: 9.9620 }, 
                seydisfjord: { name: "Seyðisfjörður", country: "IS", lat: 65.2595, lon: -14.0090 } 
            };

            function normalizeDestinationName(e) { return e ? e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ð/g, "d").replace(/[^a-z0-9]/g, "") : "" }
            function haversineDistance(e,t,o,a){const n=6371,r=(o-e)*Math.PI/180,i=(a-t)*Math.PI/180,s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 2*n*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))}
            function formatETA(e) { if (!e) return { day: "--", time: "--:--" }; try { const t = new Date(e); if (isNaN(t.getTime())) return { day: "Inv", time: "" }; const o = t.toLocaleDateString("en-GB", { weekday: "short", timeZone: "Atlantic/Faroe" }), a = t.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", hour12: !1, timeZone: "Atlantic/Faroe" }); return { day: o, time: a } } catch (e) { return { day: "Err", time: "" } } }
            
            async function fetchWeatherData(lat, lon) {
                 try {
                    const apiKey = 'AIzaSyAAXsfnLWGjbcz4RGlERJwo3Y0Soe56ryI';
                    const url = `https://weather.googleapis.com/v1/currentConditions:lookup?key=${apiKey}&location.latitude=${lat}&location.longitude=${lon}`;
                    const response = await fetch(url); if (!response.ok) throw new Error("Weather Fail"); const data = await response.json();
                    const tempEl = document.getElementById("weather-temp"); if (tempEl) tempEl.textContent = data.temperature?.degrees != null ? `${Math.round(data.temperature.degrees)}°C` : '--°C';
                    const descEl = document.getElementById("weather-description"); if (descEl) descEl.textContent = data.weatherCondition?.description?.text || "N/A";
                    const weatherIconEl = document.getElementById("weather-icon"); if (weatherIconEl) weatherIconEl.src = `https://openweathermap.org/img/wn/02d@2x.png`;
                } catch (e) { console.log("Weather error"); }
            }

            async function updateShipData(isHomePage = false) {
                try {
                    const response = await fetch("https://smyrillinewebapi-cec3fkhjh8bbhtd3.northeurope-01.azurewebsites.net/vessel/vessels");
                    const norrona = (await response.json()).find(v => v.vesselName?.toUpperCase() === 'NORRONA');
                    
                    if (!norrona) return;

                    const speedKnots = norrona.position?.speed || 0;
                    const course = Math.round(norrona.position?.course || 0);
                    
                    const currentDestKey = normalizeDestinationName(norrona.destinationFromAIS.split(",")[0].trim());
                    const currentDestInfo = destinationMap[currentDestKey] || destinationMap['torshavn'];
                    
                    const dist = haversineDistance(norrona.position.latitude, norrona.position.longitude, currentDestInfo.lat, currentDestInfo.lon);
                    
                    const isInPort = speedKnots < 1.0 && dist < 2.0;

                    const { day, time } = formatETA(norrona.etaFromAIS);
                    
                    // Opdater Header
                    if (isInPort) {
                         document.getElementById('header-dest-text').textContent = `In Harbor (${currentDestInfo.name})`;
                    } else {
                         document.getElementById('header-dest-text').textContent = `To ${currentDestInfo.name}`;
                    }

                    if (isHomePage) {
                        if (isInPort) {
                            document.getElementById('home-dest-label').textContent = "Current Status";
                            document.getElementById('destination-home').textContent = "In Harbor";
                            document.getElementById('eta-home').textContent = `Docked in ${currentDestInfo.name}`;
                        } else {
                            document.getElementById('home-dest-label').textContent = "Next Stop";
                            document.getElementById('destination-home').textContent = currentDestInfo.name;
                            document.getElementById('eta-home').textContent = `${day}, ${time}`;
                        }

                        document.getElementById('speed-knots-home').textContent = `${speedKnots} kn`; 
                        document.getElementById('speed-kmh-home').textContent = `${(speedKnots * 1.852).toFixed(1)} km/h`;
                        document.getElementById('course-home').textContent = `Course: ${course}°`;
                        
                    } else {
                        const page = document.querySelector('.voyage-page'); 
                        if(!page) return;
                        
                        document.getElementById("speed-knots").textContent = `${speedKnots} kn`; 
                        document.getElementById("speed-kmh").textContent = `${(speedKnots * 1.852).toFixed(1)} km/h`; 
                        document.getElementById("course-voyage").textContent = `Course: ${course}°`;
                        document.getElementById("onboard-time").textContent = new Date().toLocaleTimeString("en-GB", { timeZone: "Atlantic/Faroe", hour: "2-digit", minute: "2-digit" });

                        if (isInPort) {
                            document.getElementById("distance").textContent = "Docked"; 
                            document.getElementById("distance-unit").textContent = `in ${currentDestInfo.name}`;
                            document.getElementById("destination-label").textContent = "Current Location";
                            document.getElementById("destination-voyage").textContent = currentDestInfo.name;
                            document.getElementById("eta-voyage").textContent = "Arrived";
                        } else {
                            document.getElementById("distance").textContent = Math.round(dist); 
                            document.getElementById("distance-unit").textContent = "Kilometers";
                            document.getElementById("destination-label").textContent = "Next Destination";
                            document.getElementById("destination-voyage").textContent = currentDestInfo.name;
                            document.getElementById("eta-voyage").textContent = `${day} ${time}`;
                        }

                        if (map) {
                            const shipPos = [norrona.position.latitude, norrona.position.longitude]; 
                            const destPos = [currentDestInfo.lat, currentDestInfo.lon];
                            
                            // 1. UPDATE SHIP MARKER
                            if (!map.shipMarker) { 
                                map.shipMarker = L.marker(shipPos, { icon: createShipIcon(course) }).addTo(map); 
                            } else { 
                                map.shipMarker.setLatLng(shipPos);
                                map.shipMarker.setIcon(createShipIcon(course)); 
                            }

                            // 2. HANDLE DESTINATION PIN & ROUTE
                            if (isInPort) {
                                // If in port: REMOVE destination marker and route line
                                if (map.destMarker) {
                                    map.removeLayer(map.destMarker);
                                    map.destMarker = null;
                                }
                                if (liveRouteLine) {
                                    map.removeLayer(liveRouteLine);
                                    liveRouteLine = null;
                                }
                                // Zoom tight on the ship
                                map.setView(shipPos, 15);
                            } else {
                                // If sailing: SHOW destination marker and route
                                if (!map.destMarker) { 
                                    map.destMarker = L.marker(destPos, { icon: pinIcon }).addTo(map); 
                                } else { 
                                    map.destMarker.setLatLng(destPos); 
                                }
                                
                                if (liveRouteLine) { map.removeLayer(liveRouteLine); }
                                liveRouteLine = L.polyline([shipPos, destPos], { color: '#00f2ff', weight: 3, dashArray: '10, 10', opacity: 0.9 }).addTo(map);
                                map.fitBounds(L.latLngBounds(shipPos, destPos), { padding: [50, 50] });
                            }
                        }
                        
                        fetchWeatherData(currentDestInfo.lat, currentDestInfo.lon);
                    }
                } catch(e) { console.log(e); }
            }

            function initializeVoyagePage() {
                if (map) { map.remove(); map = null; }
                map = L.map("map", { zoomControl: !1, attributionControl: !1, renderer: L.canvas() }).setView([60.0, -2.0], 5);
                L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { attribution: "", subdomains: "abcd" }).addTo(map);
                const detailedRoute = [[57.59, 9.96], [57.80, 8.90], [58.20, 5.50], [59.50, 2.00],[60.85, -0.83], [61.50, -3.50], [62.01, -6.77], [62.50, -8.00],[64.00, -11.50], [65.10, -13.00], [65.26, -14.01]];
                L.polyline(detailedRoute, { color: '#ffffff', weight: 1, dashArray: '5, 15', opacity: 0.2 }).addTo(map);
                updateShipData();
            }
            setInterval(updateShipData, 60000); setInterval(updateHeaderTime, 1000); init();
        });
    </script>
</body>
</html>
